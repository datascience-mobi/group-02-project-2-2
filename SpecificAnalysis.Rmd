---
title: "Specific Analysis"
author: "TeresavL"
date: "7/6/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(gplots)
library(pheatmap)
```
## Load Data
The given data is integrated as follows:
```{r}
treated <- readRDS("~/Documents/Uni/4.Semester/Bioinfo/GitHub/project-02-group-02/data/NCI_TPW_gep_treated.rds")
untreated <- readRDS("~/Documents/Uni/4.Semester/Bioinfo/GitHub/project-02-group-02/data/NCI_TPW_gep_untreated.rds")
copynumber <- readRDS("~/Documents/Uni/4.Semester/Bioinfo/GitHub/project-02-group-02/data/CCLE_copynumber.rds")
mutations <- readRDS("~/Documents/Uni/4.Semester/Bioinfo/GitHub/project-02-group-02/data/CCLE_mutations.rds")
cellline <- read.delim("~/Documents/Uni/4.Semester/Bioinfo/GitHub/project-02-group-02/data/cellline_annotation.tsv", header = TRUE, sep = "\t")
meta <- read.delim("~/Documents/Uni/4.Semester/Bioinfo/GitHub/project-02-group-02/data/CCLE_mutations.rds", header = TRUE, sep = "\t")
```

## Scaling
We normalized our data through scaling: 
```{r}
treated.scaled <- scale(treated)
untreated.scaled <- scale(untreated)
````
## FC

```{r}
log2FC.treated.untreated <- (treated.scaled-untreated.scaled) #values are already log2 transformed
is.nan.data.frame <- function(x)      #NaN durch 0 ersetzen
  do.call(cbind, lapply(x, is.nan))
log2FC.treated.untreated[is.nan(log2FC.treated.untreated)] <- 0
`````

#Specific analysis
## Step 1 (a)
##Find Biomarker for cisplatin through FC (criterium 1)
```{r}
cisplatin.col=c()
j=1

while(j<820)
{
  if(isTRUE(meta[j,3]== "cisplatin"))
  {cisplatin.col= c(cisplatin.col,j)
  }
  j = j +1
}

FC.cisplatin = log2FC.treated.untreated[,cisplatin.col]

mean.FC.genes <- apply(FC.cisplatin, 1, mean)
mean.FC.celllines <- apply(FC.cisplatin, 2, mean)
``````

### removing unnecessary data
````{r}
rm(cisplatin.col, j, is.nan.data.frame, treated, untreated, log2FC.treated.untreated)
```````

#standard deviation cisplatin
````{r}
sd.cisplatin = apply(FC.cisplatin, 1, sd)
mean.FC.genes.sd = as.data.frame(cbind(mean.FC.genes, sd.cisplatin))
mean.FC.ordered = mean.FC.genes.sd[order(mean.FC.genes.sd$mean.FC.genes, decreasing=TRUE), ]
```````

#finding/visualizing most extreme FC values for cisplatin
````{r}
lowest.FC = mean.FC.ordered[13280:13299,]
par(mar = c(5, 7, 5, 5))
barplot(lowest.FC$mean.FC.genes,
        horiz = TRUE,
        xlim = c(-1.0, 0),
        main= "lowest log2 FC-values for cisplatin",
        xlab= "mean log2FC values in different celllines",
        names.arg = rownames(lowest.FC),
        col= "firebrick",
        las=1,
        border = "white", 
        cex.names =0.8)
legend(-1.4, 27, legend= "biomarker", box.lty=1, cex =0.8)

highest.FC = mean.FC.ordered[1:20,]
par(mar = c(5, 10, 5, 5))
barplot(highest.FC$mean.FC.genes,
        horiz = TRUE,
        xlim = c(0, 1),
        main= "highest log2 FC-values for cisplatin",
        xlab= "mean log2FC values in different celllines",
        names.arg = rownames(highest.FC),
        col= "lightgreen",
        las=1,
        border = "white",
        cex.names =0.8)
legend(-0.5, 27, legend= "biomarker", box.lty=1, cex =0.8)
``````

#matrix containing the biomarker found through the FC 
````{r}
highest.FC = as.matrix(highest.FC) 
lowest.FC = as.matrix(lowest.FC)
biomarker1.FC = as.matrix(rbind(highest.FC, lowest.FC))
highest.names <- row.names(highest.FC)
lowest.names <- row.names(lowest.FC)
row.names(biomarker1.FC) <- c(highest.names, lowest.names)
biomarker1 <- c(highest.names, lowest.names)
````

#sort out biomarker that do not change in the same "direction" for most cell lines
````{r}
is.neg = FC.cisplatin<0
i =1
j=1
a=1
biomarker2.up = c()
biomarker2.down = c()
while(j<13300){
  while(i<56){
    if(is.neg[j,i]==TRUE)
     {a=a+1}
    i=i+1}
  if(a>49)
     {biomarker2.down= c(biomarker2.down, j)}
  if(a<6)
    {biomarker2.up= c(biomarker2.up, j)}
  a=1
  i=1
  j=j+1}
`````

#das sind jetzt die nrow von Genen dich sich unter cisplatin
#in 50 von 55 Faellen in die gleiche Richtung veraendern
````{r}
biomarker2 = row.names(FC.cisplatin[c(biomarker2.down, biomarker2.up),])

#do we find the same biomarkers for cisplatin with both criteria? 
i=1
j=1
a=1
double.biomarker = c()
while(i<41)
{
  while(j<375)
      {
        if(isTRUE(biomarker2[j] == biomarker1[i]))
           {double.biomarker = c(double.biomarker, biomarker1[a])
             }
            j = j +1
         }
          j= 1
          i=i+1
          a=a+1
}

rm(is.neg, a, i, j, biomarker2.down, biomarker2.up, highest.names, lowest.names, highest.FC, lowest.FC)
``````

## Step 1 (b)
# ttest to verify significance of the biomarker
#Creating seperated matrices containing cisplatin
````{r}
treated.cisplatin <- treated.scaled[,grep ("cisplatin", colnames(treated.scaled))]
untreated.cisplatin <- untreated.scaled[,grep("cisplatin", colnames(treated.scaled))]

# 1. Normality was checked for all biomarkers through QQplots. This is an example.
par(mar = c(5, 5, 5, 5))
qqnorm(treated.cisplatin["POLR3B", ], main = "QQplot to check normality of the POLR3B gene")
qqline(treated.cisplatin["POLR3B", ])
legend(-2.5, 1.1,  cex = 0.9, box.lty = 0,
legend = "Gene expression values for POLR3B
in different celllines after cisplatin treatment.")


# 2. Welch two sample t-test. Check if the expressional change of biomarkers is significant. 
pvalues.welch <- sapply(double.biomarker, function(x){
       t.test(treated.cisplatin[x,], untreated.cisplatin[x,],paired= T)$p.value
   })
plot(density(pvalues.welch))
``````

#Step 2
#influence of cisplatin on the biomarkers gene expression in different cell lines
````{r}
double.biomarker.FC = FC.cisplatin[double.biomarker,]
colfunc <- colorRampPalette(c("firebrick","firebrick3","lightcoral",
                              "lightyellow","lightskyblue1","steelblue1",
                              "steelblue3", "darkblue"))

saveRDS(double.biomarker.FC, file = "double.biomarker.FC.rds")
`````

#checking how many clusters we will need in the heatmap (elbow plot) 
````{r}
wss = sapply(2:8, function(k) {
  kmeans(x = t(double.biomarker.FC), centers = k)$tot.withinss
})
plot(2:8, wss, type = "b",
     pch = 19,
     xlab = "Number of clusters K",
     ylab = "Total within-clusters sum of squares",
     main = "Elbow plot for kmeans clustering of celllines")
``````


#heatmap
````{r}
par(mar = c(10,5,7,5))
pheatmap(double.biomarker.FC,
         color = colfunc(20),
         cluster_cols = TRUE,
         clustering_rows = TRUE,
         clustering_method ="ward.D2",
         treeheight_row = 40,
         treeheight_col = 40,
         cutree_cols = 4,
         cutree_rows = 2, 
         legend =TRUE,
         show_colnames = F,
         border_color = "white",
         scale = "column",
         main = "Influence of cisplatin on the biomarkers gene expression")


#heatmap with annotation
colnames(double.biomarker.FC) <- meta[95:149,2]
annotation = data.frame(Cancertype = cellline$Cancer_type)
rownames(annotation) = cellline$Cell_Line_Name

pheatmap(double.biomarker.FC,
         color = colfunc(25),
         cluster_cols = TRUE,
         clustering_rows = TRUE,
         clustering_method ="ward.D2",
         treeheight_row = 30,
         treeheight_col = 30,
         annotation_col = annotation,
         legend = T,
         show_colnames = F,
         cutree_rows = 2,
         cutree_cols = 4,
         border_color = "white",
         scale = "column",
         main = "Influence of cisplatin on the biomarkers gene expression")
`````


##Step 3
#further analysis of biomarker
#amplification, deletation or neutral gene copy number
````{r}
copynumber.biomarker = as.matrix(copynumber[double.biomarker,])
copynumber.quali = ifelse(copynumber.biomarker <= (-1), (-1), ifelse (copynumber.biomarker >= (1), 1, 0))
````

#distribution of gene alterations
````{r}
quantiles = as.matrix(quantile(copynumber.biomarker))
plot(density(copynumber.biomarker))
abline(v= quantiles[c(2,4),1], col= c("red", "blue"), lty =2)
legend(-6, 1.2, legend = c("25 % quantile", "75% quantile"), col = c("red", "blue"), lty = 1:2)
`````

#checking the optimal number of cluster (elbow plot) 
````{r}
wss = sapply(2:7, function(k) {
  kmeans(x = t(copynumber.quali), centers = k)$tot.withinss
})
plot(2:7, wss, 
     type = "b", pch = 19, 
     xlab = "Number of clusters K",
     ylab = "Total within-clusters sum of squares",
     main = "Elbowplot kmeans clustering - biomarker gene alterations")

kmeans= kmeans(x = t(copynumber.quali), centers = 4, nstart = 10)
`````

#heatmap
````{r}
colfunc2 <- colorRampPalette(c("firebrick2", "grey88", "deepskyblue3"))
colfunc2(3)

pheatmap(copynumber.quali,
         color = colfunc2(3),
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         clustering_method = "ward.D2",
         legend = TRUE,
         legend_breaks = c(-3:3),
         legend_labels = c("red=deletion","","","", "", "", "blue=amplification"),
         border_color = "white",
         show_colnames = FALSE,
         cutree_rows = 4,
         cutree_cols = 4,
         annotation = annotation,
         main =  "Connection between biomarker and gene alterations")
````

