---
title: "Specific Analysis"
author: "TeresavL"
date: "7/6/2019"
output: html_document
---
```{r setup, include=FALSE, echo =F}
knitr::opts_chunk$set(echo = TRUE)
```

`````{r, echo = F, include = F}
library(readxl)
library(gplots)
library(pheatmap)

## necessary data from the general analysis
meta <- read_excel("data/NCI_TPW_metadata.xls")
untreated <- readRDS("~/Documents/Uni/4.Semester/Bioinfo/GitHub/project-02-group-02/data/NCI_TPW_gep_untreated.rds")
treated <- readRDS("~/Documents/Uni/4.Semester/Bioinfo/GitHub/project-02-group-02/data/NCI_TPW_gep_treated.rds")
copynumber <- readRDS("~/Documents/Uni/4.Semester/Bioinfo/GitHub/project-02-group-02/data/CCLE_copynumber.rds")
cellline <- read_excel("data/cellline_annotation.xls")
meta = as.data.frame(meta)
celline = as.data.frame(cellline)

#scale
treated.scaled <- scale(treated)
untreated.scaled <- scale(untreated)

#FC
log2FC.treated.untreated <- (treated.scaled-untreated.scaled) #values are already log2 transformed
is.nan.data.frame <- function(x)      #NaN durch 0 ersetzen
  do.call(cbind, lapply(x, is.nan))
log2FC.treated.untreated[is.nan(log2FC.treated.untreated)] <- 0
```````

***
### Table of contents
1. [Step 1: Identification of genes as biomarker](#step1)  
    1.1 [Finding Biomarker for cisplatin](#step1a)  
    1.2 [Testing significance](#significance)  
2. [Step 2: Biomarker gene expression](#upordown)  
3. [Step 3: Further evaluation of biomarker gene](#alterations)  


### Step 1: Can we identify genes as significant biomarker for cisplatin? <a name="step1"></a>

#### Step 1a: Finding Biomarker for cisplatin
##### Criterium: High fold-change values throughout the cell lines
Bevor the specific analysis was started, the gene expression values were scaled, NA values were removed and the log2 fold change was computed. The mean fold-change for each gene was computed, as well as the mean fold-change for each celline.

The applied criterium to identify certain genes as biomarker for cisplatin is the expression fold change between tumor samples and treated tumor samples. The cisplatin treatment was the same for all cell lines: 15000nM and 24 hours.
The genes, which gene expression changes throughout all cell lines upon cisplatin pertubation the most also show the most extreme fold change values. So, the 20 highest and 20 lowest FC were selected. 

`````{r, echo = F}
cisplatin.col=c()
j=1

while(j<820)
{
  if(isTRUE(meta[j,3]== "cisplatin"))
  {cisplatin.col= c(cisplatin.col,j)
  }
  j = j +1
}

FC.cisplatin = log2FC.treated.untreated[,cisplatin.col]

mean.FC.genes <- apply(FC.cisplatin, 1, mean)
mean.FC.celllines <- apply(FC.cisplatin, 2, mean)
```````


The bar shows the biomarkers expression fold-changes between tumor samples and treated tumor samples.

````{r, echo = F, include = T, dpi = 70}
sd.cisplatin = apply(FC.cisplatin, 1, sd)
mean.FC.genes.sd = as.data.frame(cbind(mean.FC.genes, sd.cisplatin))
mean.FC.ordered = mean.FC.genes.sd[order(mean.FC.genes.sd$mean.FC.genes, decreasing=TRUE), ]

lowest.FC = mean.FC.ordered[13280:13299,]
par(mar = c(5, 7, 5, 5))
barplot(lowest.FC$mean.FC.genes,
        horiz = TRUE,
        xlim = c(-1.0, 0),
        main= "lowest log2 FC-values for cisplatin",
        xlab= "mean log2FC values in different celllines",
        names.arg = rownames(lowest.FC),
        col= "firebrick",
        las=1,
        border = "white", 
        cex.names =0.8)

highest.FC = mean.FC.ordered[1:20,]
par(mar = c(5, 10, 5, 5))
barplot(highest.FC$mean.FC.genes,
        horiz = TRUE,
        xlim = c(0, 1),
        main= "highest log2 FC-values for cisplatin",
        xlab= "mean log2FC values in different celllines",
        names.arg = rownames(highest.FC),
        col= "lightgreen",
        las=1,
        border = "white",
        cex.names =0.8)
``````

`````{r, echo= F}
#matrix containing the biomarker found through the FC 
highest.FC = as.matrix(highest.FC) 
lowest.FC = as.matrix(lowest.FC)
biomarker1.FC = as.matrix(rbind(highest.FC, lowest.FC))
highest.names <- row.names(highest.FC)
lowest.names <- row.names(lowest.FC)
row.names(biomarker1.FC) <- c(highest.names, lowest.names)
biomarker1 <- c(highest.names, lowest.names)
`````


#### Additional criterium: Same direction
For the second criterium only those biomarker, which change in the same "direction" for most cell lines were selected. This kind of selection was inspired by "The NCI Transcriptional Pharmacodynamics Workbench: A Tool to Examine Dynamic Expression Profiling of Therapeutic Response in the NCI-60 Cell Line Panel.", Monks et. al. Monks et. al. define consistent transcriptional changes as those in which expression of the majority of cell lines changed in the same direction for that gene, and only a small percentage of cell lines had a change in the opposite direction. 
So genes, which change in 50 of 55 cell lines in the same direction upon cisplatin treatment (up or down regulation) were selected. 


Specifies the first criterium - gene expression changes in the same direction (cisplatin might work especially for patients with a gene expression in the same direction)


```{r, echo=T}
is.neg = FC.cisplatin<0
i =1
j=1
a=1
biomarker2.up = c()
biomarker2.down = c()
while(j<13300){
  while(i<56){
    if(is.neg[j,i]==TRUE)
     {a=a+1}
    i=i+1}
  if(a>49)
     {biomarker2.down= c(biomarker2.down, j)}
  if(a<6)
    {biomarker2.up= c(biomarker2.up, j)}
  a=1
  i=1
  j=j+1}
```

````{r, echo =F}
biomarker2 = row.names(FC.cisplatin[c(biomarker2.down, biomarker2.up),])
`````


#### Do we find the same biomarker for cisplatin with both criteria? 
Finally we combined these two criteria and defined genes as biomarker for cisplatin only if they were selected through both criteria. As a result, 15 genes were found. 
```{r, echo = F, include=TRUE}
i=1
j=1
a=1
double.biomarker = c()
while(i<41)
{
  while(j<375)
      {
        if(isTRUE(biomarker2[j] == biomarker1[i]))
           {double.biomarker = c(double.biomarker, biomarker1[a])
             }
            j = j +1
         }
          j= 1
          i=i+1
          a=a+1
}

double.biomarker.FC = FC.cisplatin[double.biomarker,]
double.biomarker

```


  


#### Step 1b: How significant are the previously found biomarker? <a name="significance"></a>

__T-test to verify significance of the biomarker__  

Creating seperated matrices containing cisplatin.
```{r, echo = F}
treated.cisplatin <- treated.scaled[,grep ("cisplatin", colnames(treated.scaled))]
untreated.cisplatin <- untreated.scaled[,grep("cisplatin", colnames(treated.scaled))]
```

**1. Checking normality**  
Normality was checked for all biomarkers through QQplots. This is an example for the POLR3B gene. 
````{r, echo = F, include = T}
par(mar = c(5, 5, 5, 5))
qqnorm(treated.cisplatin["POLR3B", ], main = "QQplot to check normality of the POLR3B gene")
qqline(treated.cisplatin["POLR3B", ])
legend(-2.5, 1.1,  cex = 0.9, box.lty = 0,
legend = "Gene expression values for POLR3B
in different celllines after cisplatin treatment.")
````

**2. Welch two sample t-test**  
Check if the expressional change of biomarkers is significant. 
````{r}
pvalues.welch <- sapply(double.biomarker, function(x){
       t.test(treated.cisplatin[x,], untreated.cisplatin[x,],paired= T)$p.value
   })
plot(density(pvalues.welch))
``````

Low p-values --> biomarker genes seem to be significant

__Standard deviation to check consistency of fold-changes across cell lines__  

Fold-change values upon cisplatin pertubation related to their standard deviation, to check consistency across the cell lines for biomarker genes.  
`````{r, echo = F, include= F}
sd.cisplatin = apply(FC.cisplatin, 1, sd)
mean.FC.genes.sd = as.data.frame(cbind(mean.FC.genes, sd.cisplatin))
mean.FC.ordered = mean.FC.genes.sd[order(mean.FC.genes.sd$mean.FC.genes, decreasing=TRUE), ]
head(mean.FC.genes.sd)
plot(density(sd.cisplatin))
```

```{r, echo = F, include = T}
# checking consistency with standard deviation for double.biomarker
mean.double <- apply(double.biomarker.FC, 1, mean)
sd.double <- apply(double.biomarker.FC, 1, sd)
double = cbind(mean.double, sd.double)
colnames(double) = c("mean FC","SD" )
double
`````

High standard deviation values, so the fold-changes vary a lot between cell lines. A tissue based separation and selection of cancers which are regularly treated with cisplatin (testicular carcinoma, ovarian and bladder cancer) might result in fold-change values with less variance and also in different biomarker genes. 


***

### Step 2: Influence of cisplation on the biomarkers gene expression in different cell lines <a name="upordown"></a>
Influence of cisplatin on the biomarkers gene expression in different cell lines. Evaluating whether cisplatin has an influence on up- or downregulation of the biomarkers gene expression. Again we evaluated all cellines, but tried to find patterns. (tissues etc)
````{r, echo = F}
colfunc <- colorRampPalette(c("firebrick","firebrick3","lightcoral",
                              "lightyellow","lightskyblue1","steelblue1",
                              "steelblue3", "darkblue"))
`````

##### checking how many clusters we will need in the heatmap (elbow plot) 
For the heatmap, celllines and biomarker genes were clustered with kmeans, method ward.D2. Therefore we evaluated the optimal number of clusters with the help of an elbow plot.


```{r, echo = F, include = T, dpi = 80, fig.align='center'}
wss = sapply(2:7,function(k) {
  kmeans(x = t(double.biomarker.FC), centers = k)$tot.withinss
})

plot(2:7, wss, type = "b",
     pch = 19,
     xlab = "Number of clusters K",
     ylab = "Total within-clusters sum of squares",
     main = "Elbow plot for kmeans clustering of celllines")

kmeans= kmeans(x = t(double.biomarker.FC), centers = 5, nstart = 10)
kmeans$tot.withinss
````

### Influence of cisplatin on the biomarkers gene expression
Annotation = Cancer types. 


```{r dpi = 200, echo = F}
colnames(double.biomarker.FC) <- meta[95:149,2]
annotation = data.frame(Cancertype = cellline$Cancer_type)
rownames(annotation) = cellline$Cell_Line_Name

pheatmap(double.biomarker.FC,
         color = colfunc(25),
         cluster_cols = TRUE,
         clustering_rows = TRUE,
         clustering_method ="ward.D2",
         treeheight_row = 30,
         treeheight_col = 30,
         annotation_col = annotation,
         legend = T,
         legend_breaks = c(-1,1),
         legend_labels = c("down", "up"),
         show_colnames = F,
         cutree_rows = 2,
         cutree_cols = 4,
         border_color = "white",
         scale = "column")
```````


***

### Step 3: Further analysis of biomarker <a name="geneticalterations"></a>
Do we find an amplification, deletation or neutral gene copy number? 
Values smaller than -1 indicate an deletation, values higher than 1 an amplification. All values in between -1 and 1 represent a neutral gene copy number. 

````{r}
copynumber.biomarker = as.matrix(copynumber[double.biomarker,])
copynumber.quali = ifelse(copynumber.biomarker <= (-1), (-1), ifelse (copynumber.biomarker >= (1), 1, 0))
````

#### distribution of gene alterations - ganz raus? 
Visualizing the distribution of genetic alterations. 
````{r, echo = F, include = T, dpi = 100}
quantiles = as.matrix(quantile(copynumber.biomarker))
plot(density(copynumber.biomarker))
abline(v= quantiles[c(2,4),1], col= c("red", "blue"), lty =2)
legend(-6, 1.2, legend = c("25 % quantile", "75% quantile"), col = c("red", "blue"), lty = 1:2)
`````

#### checking the optimal number of cluster (elbow plot) 
````{r, echo = F, include = T, warning = F, dpi = 80}
wss = sapply(2:7, function(k) {
  kmeans(x = t(copynumber.quali), centers = k)$tot.withinss
})
plot(2:7, wss, 
     type = "b", pch = 19, 
     xlab = "Number of clusters K",
     ylab = "Total within-clusters sum of squares",
     main = "Elbowplot kmeans clustering - biomarker gene alterations")

kmeans= kmeans(x = t(copynumber.quali), centers = 5, nstart = 10)
kmeans$tot.withinss
`````


  
  
### Connection between biomarker and gene alterations

````{r fig.align = 'right', echo = F, include = T, dpi = 160}
colfunc2 <- colorRampPalette(c("firebrick2", "grey88", "deepskyblue3"))

colnames(double.biomarker.FC) <- meta[95:149,2]
annotation = data.frame(Cancertype = cellline$Cancer_type)
rownames(annotation) = cellline$Cell_Line_Name

pheatmap(copynumber.quali,
         color = colfunc2(3),
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         clustering_method = "ward.D2",
         legend = TRUE,
         legend_breaks = c(-1,0,1),
         legend_labels = c("deletion","", "amplification"),
         border_color = "white",
         show_colnames = FALSE,
         cutree_rows = 4,
         cutree_cols = 3,
         treeheight_row = 20,
         treeheight_col = 20,
         annotation = annotation)
````
