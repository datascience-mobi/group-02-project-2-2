---
title: "Broad Analysis"
date: "5 Juni 2019"
output:
  html_document: default
  pdf_document: default
---
```{r}
library(viridis)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Data
The given data is integrated as follows:
```{r}
treated <- readRDS("C:/Users/johan/Documents/Bioinfo_project/NCI_TPW_gep_treated.rds")
untreated <- readRDS("C:/Users/johan/Documents/Bioinfo_project/NCI_TPW_gep_untreated.rds")
ic50 <- readRDS("C:/Users/johan/Documents/Bioinfo_project/NegLogGI50.rds")
basalexp <- readRDS("C:/Users/johan/Documents/Bioinfo_project/CCLE_basalexpression.rds")
copynumber <- readRDS("C:/Users/johan/Documents/Bioinfo_project/CCLE_copynumber.rds")
mutations <- readRDS("C:/Users/johan/Documents/Bioinfo_project/CCLE_mutations.rds")
cellline <- read.delim("C:/Users/johan/Documents/Bioinfo_project/cellline_annotation.tsv", header = TRUE, sep = "\t")
meta <- read.delim("C:/Users/johan/Documents/Bioinfo_project/cellline_annotation.tsv", header = TRUE, sep = "\t")
drug <- read.delim("C:/Users/johan/Documents/Bioinfo_project/drug_annotation.tsv", header = TRUE, sep = "\t")
```

## Remove NAs
In order to clean up our data, we created a loop for checking the amount of NAs in every matrix. Then, two coloumns, which only contained of NAs were removed out of the mutations matrix.
```{r}
list.na = list("treated"=treated, "untreated"=untreated, "mutations"=mutations, "basalexp" = basalexp, "cellline"=cellline, "copynumber"=copynumber, "ic50"=ic50, "meta"=meta)
myfunc = function(x){sum(is.na(x))}

i = 0
while(i<9)
{
  p=sapply(list.na[i],myfunc)
  print(p)
  i = i +1
}

mutations.removed = mutations[, -(12:13)]
```

## Scaling
For normalizing our data, scale was used. 
```{r}
#scale
basal.scaled <- scale(basalexp)
treated.scaled <- scale(treated)
untreated.scaled <- scale(untreated)
```

## Coloring every drug
```{r}
library(ggplot2)
library(reshape2)

melt = melt(treated)
drugcolor = vector()
x=1
while(x < 820){
  drugcolor = c(drugcolor, rep( as.character(meta[x,3]) , 13299))
  x=x+1
}
melt = cbind(melt ,drugcolor)

cols15 <- c("#d7ff2e","#2f0085","#02ee81","#f357ff",
            "#86ae00","#ff2f86","#008118","#ff443e",
            "#008b9d","#ffcd77","#1a001e","#f8ffb4",
            "#b6a7ff","#572a00","#c8fff7")

ggplot(melt, aes(x = Var2, y = value)) + labs(y='Gene') + theme_bw() +
  geom_boxplot(aes(fill = melt$drugcolor, color=melt$drugcolor) ,outlier.size = 0.1) +
  ggtitle("Gene Expression Treated") +
  scale_fill_manual(name= melt$drugcolor, values = cols15) + 
  scale_color_manual(name = melt$drugcolor , values = cols15)
```


## Boxplot treated without scaling
In order to get an overview a boxplot of the treated data was computed. There was a visible difference between the 15 batches. 

###each drug is colored in a different color
```{r}
boxplot(treated, xlab = "Samples", horizontal = F, border = drugcolorvector, main = "Gene Expression Treated")
```

## Boxplot treated with scaling
Through scaling the data the different batches dissapeared.

####color
```{r}
boxplot(treated.scaled, xlab="Samples", horizontal = F, border = drugcolorvector, main = "Gene Expression Treated Scaled")
```

## Fold Change Treated/Untreated
In order to analyse the gene expression change from untreated to treated, log2 fold change values were computed. The distribution was checked through a density plot.
```{r}
log2FC.treated.untreated <- log2(treated.scaled/untreated.scaled)
is.nan.data.frame <- function(x)      #NaN durch 0 ersetzen
  do.call(cbind, lapply(x, is.nan))
log2FC.treated.untreated[is.nan(log2FC.treated.untreated)] <- 0
plot(density(log2FC.treated.untreated), main = "Log2 FC Treated/Untreated")
```

## PCA
For a dimensional reduction, a principal component analysis was performed. The PCA was interpreted by plotting the first four components and coloring different groups of data.
First chemotherapeutics and targeted drugs were colored in both plots. This did not seperate the data in visible groups. 
Next each drug was colored in a different color, the color scheme remained the same as bevore. Here PC3 and PC4 seem to seperate the diffenrent drugs. Especially vorinostat was seperated from the rest of the data.
Lastly 4 tyrosine kinase inhibitors drugs were colored. There was no seperation visible.
```{r}
PCA.FC <- prcomp(log2FC.treated.untreated, center=F , scale.=F)
plot(PCA.FC, type ="lines")
plot(PCA.FC$rotation[, 1], PCA.FC$rotation[, 2], xlab = "PC1", ylab = "PC2", pch=19, main = "PCA Treated/Untreated")
plot(PCA.FC$rotation[, 3], PCA.FC$rotation[, 4], xlab = "PC3", ylab = "PC4", pch = 19, main = "Treated/Untreated")
```

## How many variance can be explained by the principle components?
```{r}
Varianz.PCA=PCA.FC$sdev^2
```

## colored PCA (drugs)
plot(PCA.FC$rotation[, 1], PCA.FC$rotation[, 2], col=drug.color.vector, xlab = "PC1", ylab = "PC2", pch=19, main ="PCA Drugs")
plot(PCA.FC$rotation[, 3], PCA.FC$rotation[, 4], col=drug.color.vector, xlab = "PC3", ylab = "PC4", pch=19, main = "PCA Drugs")

## colored PCA chemo/targeted
```{r}
targeted.chemo <- c("targeted", "targeted", "chemo", "chemo", "chemo", "chemo", "chemo", "targeted", "targeted", "chemo", "chemo", "chemo", "chemo", "targeted", "chemo")
drug.added <- cbind(drug, targeted.chemo)
drug.added.ordered <- drug.added[order(drug.added$Drug),]
chemocolor <- ifelse(drug.added.ordered$targeted.chemo=="chemo", "firebrick", "forestgreen")
chemocolordrugs <- cbind(chemocolor, rownames(drugnames))
chemocolorvector <- sapply(rownames(meta), function(x){
       unname(chemocolordrugs[meta[x, 3]], force = FALSE)
   })
#plot
plot(PCA.FC$rotation[, 1], PCA.FC$rotation[, 2], col=chemocolorvector, xlab = "PC1", ylab = "PC2", pch=19, main ="PCA Drugs")
plot(PCA.FC$rotation[, 3], PCA.FC$rotation[, 4], col=chemocolorvector, xlab = "PC3", ylab = "PC4", pch=19, main = "PCA Drugs")
```

## colored PCA tyrosine kinase inhibitor 
```{r}
tyrosincolor <- ifelse(drugnames.ordered$Mechanism=="Tyrosine kinase inhibitor", "firebrick", "forestgreen")
tyrosincolordrugs <- cbind(tyrosincolor, rownames(drugnames.ordered))
tyrosincolorvector <- sapply(rownames(meta), function(x){
          unname(tyrosincolor[meta[x, 3]], force = FALSE)
      })
#plot
plot(PCA.FC$rotation[, 1], PCA.FC$rotation[, 2], col=tyrosincolorvector, xlab = "PC1", ylab = "PC2", pch=19, main = "PCA Tyrosin Kinase Inhibitor")
plot(PCA.FC$rotation[, 3], PCA.FC$rotation[, 4], col=tyrosincolorvector, xlab = "PC3", ylab = "PC4", pch=19, main = "PCA Tyrosin Kinase Inhibitor")
```