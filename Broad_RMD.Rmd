---
title: "Broad Analysis"
date: "5 Juni 2019"
output:
  html_document: default
  pdf_document: default
---
```{r}
library(viridis)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Data
The given data is integrated as follows:
```{r}
treated <- readRDS("C:/Users/johan/Documents/Bioinfo_project/NCI_TPW_gep_treated.rds")
untreated <- readRDS("C:/Users/johan/Documents/Bioinfo_project/NCI_TPW_gep_untreated.rds")
ic50 <- readRDS("C:/Users/johan/Documents/Bioinfo_project/NegLogGI50.rds")
basalexp <- readRDS("C:/Users/johan/Documents/Bioinfo_project/CCLE_basalexpression.rds")
copynumber <- readRDS("C:/Users/johan/Documents/Bioinfo_project/CCLE_copynumber.rds")
mutations <- readRDS("C:/Users/johan/Documents/Bioinfo_project/CCLE_mutations.rds")
cellline <- read.delim("C:/Users/johan/Documents/Bioinfo_project/cellline_annotation.tsv", header = TRUE, sep = "\t")
meta <- read.delim("C:/Users/johan/Documents/Bioinfo_project/NCI_TPW_metadata.tsv", header = TRUE, sep = "\t")
drug <- read.delim("C:/Users/johan/Documents/Bioinfo_project/drug_annotation.tsv", header = TRUE, sep = "\t")
```

## Remove NAs
In order to clean up our data, we created a loop for checking the amount of NAs in every matrix. Then, two coloumns, which only contained NAs were deleated out of the mutations matrix.
```{r}
list.na = list("treated"=treated, "untreated"=untreated, "mutations"=mutations, "basalexp" = basalexp, "cellline"=cellline, "copynumber"=copynumber, "ic50"=ic50, "meta"=meta)
myfunc = function(x){sum(is.na(x))}

i = 0
while(i<9)
{
  p=sapply(list.na[i],myfunc)
  print(p)
  i = i +1
}

mutations.removed = mutations[, -(12:13)]
```

## Scaling
For normalizing our data, scale was used. 
```{r}
#scale
basal.scaled <- scale(basalexp)
treated.scaled <- scale(treated)
untreated.scaled <- scale(untreated)
```


## Boxplot treated without scaling
In order to get an overview a boxplot of the treated data was computed. There was a visible difference between the 15 batches. 

###each drug is colored in a different color

## Boxplot treated with scaling
Through scaling the data the different batches dissapeared.

## Coloring every drug in the scaled boxplot





## Computation of the Fold Change - Treated/Untreated
In order to analyse the gene expression change from untreated to treated, log2 fold change values were computed. The distribution was checked through a density plot. The values are located near to 0. 
```{r}
log2FC.treated.untreated <- log2(treated.scaled/untreated.scaled)
is.nan.data.frame <- function(x)      #NaN durch 0 ersetzen
  do.call(cbind, lapply(x, is.nan))
log2FC.treated.untreated[is.nan(log2FC.treated.untreated)] <- 0
plot(density(log2FC.treated.untreated), main = "Log2 FC Treated/Untreated")
```

## PCA
For a dimensionallity reduction, a principal component analysis was performed. The PCA was interpreted by plotting the first four components in different plots, and coloring different groups of data.
First chemotherapeutics and targeted drugs were colored in both plots. This did not seperate the data in visible groups. 
Next each drug was colored in a different color, the color scheme remained the same as bevore. Here PC3 and PC4 seem to seperate the diffenrent drugs. Especially vorinostat was seperated from the rest of the data.
Lastly 4 tyrosine kinase inhibitors drugs were colored. There was no seperation visible in PC1 and PC2, in the plot with PC3 and PC4 the Tyrosin Kinases seem to concentrate at a point.
```{r}
PCA.FC <- prcomp(log2FC.treated.untreated, center=F , scale.=F)
plot(PCA.FC, type ="lines")
plot(PCA.FC$rotation[, 1], PCA.FC$rotation[, 2], xlab = "PC1", ylab = "PC2", pch=19, main = "PCA Treated/Untreated")
plot(PCA.FC$rotation[, 3], PCA.FC$rotation[, 4], xlab = "PC3", ylab = "PC4", pch = 19, main = "Treated/Untreated")
```

## How many variance can be explained by the principle components?
```{r}
Varianz.PCA=PCA.FC$sdev^2
```

## colored PCA (drugs)
plot(PCA.FC$rotation[, 1], PCA.FC$rotation[, 2], col=drugcolorvector, xlab = "PC1", ylab = "PC2", pch=19, main ="PCA Drugs")
plot(PCA.FC$rotation[, 3], PCA.FC$rotation[, 4], col=drugcolorvector, xlab = "PC3", ylab = "PC4", pch=19, main = "PCA Drugs")

## colored PCA chemo/targeted
```{r}
list.chemo = list("cisplatin","dasatinib","doxorubicin","geldanamycin","gemcitibine","lapatinib","paclitaxel","sorafenib","sunitinib","topotecan")
chemo = c()
i=1
j=1
while(i<16)
{
  while(j<820)
  {
       if(isTRUE(meta[j,3]== list.chemo[i]))
       {chemo= c(chemo,j)
         }
        j = j +1
  }
  j= 1
  i=i+1
}
 

FC.named <- log2FC.treated.untreated
colnames(FC.named)[chemo] <- "chemo"
color.chemo <- ifelse(colnames(FC.named)=="chemo", "firebrick","forestgreen")

#plot
plot(PCA.FC$rotation[, 1], PCA.FC$rotation[, 2], col=color.chemo, xlab = "PC1", ylab = "PC2", pch=19, main ="PCA Drugs")
plot(PCA.FC$rotation[, 3], PCA.FC$rotation[, 4], col=color.chemo, xlab = "PC3", ylab = "PC4", pch=19, main = "PCA Drugs")
```

## colored PCA tyrosine kinase inhibitor 
```{r}
tyrosincolor <- ifelse(drugnames.ordered$Mechanism=="Tyrosine kinase inhibitor", "firebrick", "forestgreen")
tyrosincolordrugs <- cbind(tyrosincolor, rownames(drugnames.ordered))
tyrosincolorvector <- sapply(rownames(meta), function(x){
          unname(tyrosincolor[meta[x, 3]], force = FALSE)
      })
#plot
plot(PCA.FC$rotation[, 1], PCA.FC$rotation[, 2], col=tyrosincolorvector, xlab = "PC1", ylab = "PC2", pch=19, main = "PCA Tyrosin Kinase Inhibitor")
plot(PCA.FC$rotation[, 3], PCA.FC$rotation[, 4], col=tyrosincolorvector, xlab = "PC3", ylab = "PC4", pch=19, main = "PCA Tyrosin Kinase Inhibitor")
```