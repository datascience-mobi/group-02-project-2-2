---
title: "3. RGES"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<div style="text-align: justify"> 

```{r include = FALSE}
treated <- readRDS("C:/Users/amvog/Documents/GitHub/project-02-group-02/data/NCI_TPW_gep_treated.rds")
untreated <- readRDS("C:/Users/amvog/Documents/GitHub/project-02-group-02/data/NCI_TPW_gep_untreated.rds")
meta <- read.delim("C:/Users/amvog/Documents/GitHub/project-02-group-02/data/cellline_annotation.tsv", header = TRUE, sep = "\t")
basalexp <- readRDS("C:/Users/amvog/Documents/GitHub/project-02-group-02/data/CCLE_basalexpression.rds")
nbinom.basal.untreated=readRDS("C:/Users/amvog/Documents/GitHub/project-02-group-02/data/nbinom.basal.untreated.rds")
nbinom.treated.untreated=readRDS("C:/Users/amvog/Documents/GitHub/project-02-group-02/data/nbinom.treated.untreated.rds")
results=readRDS("C:/Users/amvog/Documents/GitHub/project-02-group-02/data/results.rds")
untreated.fit = 2^(subset(untreated, rownames(untreated) %in% rownames(basalexp)))
treated.fit = 2^(subset(treated, rownames(treated) %in% rownames(basalexp)))

```

# 3. Reverse gene expression score
RGES is a value, which measures the drugs potency to reverse a disease induced gene expression.

## Table of contents
3.1. [Signatures](#signatures)  
3.2. [RGES Computation](#rges)  
3.3. [Sources](#sources)  


## Used library
```{r, echo=TRUE}
library(DESeq)
## Data preparation 
```

First, the basal expression matrix had to be adjusted to the treated and untreated expression matrices, because they contained different genes in different orders. The three matrices were needed to compute signatures with which the RGES was computed.


``` {r eval=FALSE}
new.basal.names <- as.character(meta.matrix[1:819,2])
output.dataset <- sapply(seq_along(new.basal.names), function(a) {
  name_picker <- new.basal.names[a]
  out <- dataset.basal[,which(colnames(dataset.basal) == name_picker)]
  return(out)
})

basal.fitted.untreated <- matrix(unlist(output.dataset), nrow = 11461, ncol = 819, byrow=FALSE, dimnames = NULL)
colnames(basal.fitted.untreated) <- make.names(new.basal.names, unique = TRUE)

rownames(basal.fitted.untreated)= make.names(rownames(basal.fit), unique = TRUE)
```


## 3.1. Signatures <a name="signatures"></a> 
Bin Chen *et al.* computed the drug signatures using the DESeq package, that uses negative binomial distribution to analyse a change in gene expression between two expiremental conditions (treated and untreated). First, size factors were computed in order to estimate the library size. This was done for normalization. Afterwards the variances for each gene were computed (dispersions).
Finally the nbinomTest was used, that compares the base mean of two matrices row by row. 

In this case, two different signatures were computed. Disease signature refers to the difference of basal and untreated expression and drug signature to treated and untreated expression.

```{r eval=FALSE}

mode(treated.fit) <- "integer"
mode(untreated.fit) <- "integer"
treated.untreated <- cbind(treated.fit,untreated.fit)
cds = newCountDataSet(countData = treated.untreated, conditions = c(rep("treated",819),rep("untreated",819)))
cds = estimateSizeFactors(cds)
cds = estimateDispersions(cds)
str( fitInfo(cds) )
dispersion.values = fData(cds)
nbinom.treated.untreated = nbinomTest(cds, "treated", "untreated")
hist(nbinom.treated.untreated$pval, breaks=100, col="skyblue", border="slateblue", main="p-values nbinom")
```

The nbinomTest results in a p value for every gene, which is adjusted with Benjamini Hochberg procedure. For the disease signature the majority of p values indicated a significant outcome. And for the drug signature the values are either very significant or not at all. Genes that don`t lead to a significant p value were sorted out later.

```{r echo = FALSE}
hist(nbinom.treated.untreated$padj, breaks=100, col="skyblue", border="slateblue", main="p-values nbinom drug signature")
```

```{r echo= FALSE}
hist(nbinom.basal.untreated$padj, breaks=100, col="skyblue", border="slateblue", main="p-values nbinom disease signature")
```

In addition, the nbinomTest results in a data frame, that contains different important values like the log2 fold change.

``` {r echo=FALSE}
head(nbinom.basal.untreated)
```

Bin Chen *et al.* used a critera to decide which genes are part of the signature. This criteria mostly depends on the p value and log2 fold change. The log2 fold change values for treated, untreated and basal were too small to pass the log2 fold change criteria, so this part was left out. The p value must be below 0.001. 

Only the 1223 genes, that passed that criteria in both signatures, were used for further analysis.


## 3.2. RGES Computation <a name="rges"></a> 
Bin Chen *et al.* shared the code, that was used to compute the RGES on github. Along with the original code, they offer a short example code, that can be used to understand which steps are crucial. Since the complete code is very complex the following code is mostly based on the example code. 
Most importantly, the function cmap_score_new was adopted from Bin Chen et all. It computes RGES values. 

Different kinds of data were needed in order to compute the RGES.
Drug signature contains scaled log 2 fold change values between treated and untreated data for all genes that passed the criteria above. Disease signatures are identical but contain the log 2 fold change between basal and untreated data.
The function cmap_score_new also requires the id of down or up regulated genes from the diease signature.

```{r eval= TRUE}
dz_genes_up <- subset(nbinom.basal.untreated, log2FoldChange > 0,select="id")
dz_genes_down <- subset(nbinom.basal.untreated, log2FoldChange <0 ,select="id")
gene.list <- rownames(disease_signature)
``` 

The loop from Bin Chen *et al.* ranks the disease signature values and calculates a RGES value for every sample:

```{r eval=FALSE}
dz_cmap_scores <- NULL
count <- 0
for (exp_id in sig.ids) {
  count <- count + 1
  print(count)
  if (landmark ==1){
    cmap_exp_signature <- data.frame(gene.list,  rank(-1 * lincs_signatures[, as.character(exp_id)], ties.method="random"))    
  }else{
    cmap_exp_signature <- cbind(gene.list,  get.sigs(exp_id))    
  }
  colnames(cmap_exp_signature) <- c("ids","rank")
  dz_cmap_scores <- c(dz_cmap_scores, cmap_score_new(dz_genes_up,dz_genes_down,cmap_exp_signature))
}
```

Since the genes from the matrices are not divided into landmark genes and other genes, this part of the code was removed. Besides this, the data was adapted to the code beforehand, so there wasn`t much adjustment necessary.

```{r eval = FALSE}
dz_cmap_scores <- NULL
count <- 0
for(count in sig.ids){
  cmap_exp_signature <- data.frame(gene.list,  rank(-1 * drug_signature[, count], ties.method="random"))    
  colnames(cmap_exp_signature) <- c("ids","rank") 
  dz_cmap_scores <- c(dz_cmap_scores, cmap_score_new(dz_genes_up,dz_genes_down,cmap_exp_signature)) 
  count <- count + 1
}
```

The calculated RGES values were added to the meta data in order to connect the values to drug, cell line and tissue.

``` {r echo=FALSE}
head(results)
```


## 3.3. Sources <a name="sources"></a> 
https://github.com/Bin-Chen-Lab/RGES

Chen, B. et al. Reversal of cancer gene expression correlates
with drug efficacy and reveals therapeutic targets. Nat. Commun. 8, 16022
doi: 10.1038/ncomms16022 (2017)

</div>
