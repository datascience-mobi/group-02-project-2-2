---
title: "Final Presentation"
author: "TeresavL"
date: "7/15/2019"
output:
  ioslides_presentation:
    widescreen: true
    smaller: true
  slidy_presentation: default
  beamer_presentation: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


# Broad Analysis

## Computation of the Fold-change - treated/untreated
```{r, include = FALSE}

library(viridis)
library(ggplot2)

treated <- readRDS("C:/Users/johan/Documents/Bioinfo_project/NCI_TPW_gep_treated.rds")
untreated <- readRDS("C:/Users/johan/Documents/Bioinfo_project/NCI_TPW_gep_untreated.rds")
ic50 <- readRDS("C:/Users/johan/Documents/Bioinfo_project/NegLogGI50.rds")
basalexp <- readRDS("C:/Users/johan/Documents/Bioinfo_project/CCLE_basalexpression.rds")
copynumber <- readRDS("C:/Users/johan/Documents/Bioinfo_project/CCLE_copynumber.rds")
mutations <- readRDS("C:/Users/johan/Documents/Bioinfo_project/CCLE_mutations.rds")
cellline <- read.delim("C:/Users/johan/Documents/Bioinfo_project/cellline_annotation.tsv", header = TRUE, sep = "\t")
meta <- read.delim("C:/Users/johan/Documents/Bioinfo_project/NCI_TPW_metadata.tsv", header = TRUE, sep = "\t")
drug <- read.delim("C:/Users/johan/Documents/Bioinfo_project/drug_annotation.tsv", header = TRUE, sep = "\t")

basal.scaled <- scale(basalexp)
treated.scaled <- scale(treated)
untreated.scaled <- scale(untreated)

log2FC.treated.untreated <- treated.scaled - untreated.scaled
is.nan.data.frame <- function(x)      #NaN durch 0 ersetzen
  do.call(cbind, lapply(x, is.nan))
log2FC.treated.untreated[is.nan(log2FC.treated.untreated)] <- 0
```
```{r, echo= FALSE}
plot(density(log2FC.treated.untreated), main = "Log2 FC Treated/Untreated")
```

## Principal component analysis - treated/untreated
```{r, include=FALSE}
PCA.FC <- prcomp(log2FC.treated.untreated, center=F , scale.=F)
```
```{r, echo = FALSE}
plot(PCA.FC, type ="lines")
```

## Colored PCA by drugs
```{r, echo=FALSE}
pca = prcomp(log2FC.treated.untreated)
meta_neu = meta[1:819,]
meta_neu = as.data.frame(meta_neu)
```
```{r, echo=FALSE, fig.width=4, fig.height=4, out.extra='style="float:left"'}
pca_plot_drugs12 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,1], y = pca$rotation[,2])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$drug))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  #mit BREWER: scale_fill_brewer(palette = "Dark2")
  ggtitle("Principal Component Analysis - color drugs") +
  xlab("Principal Component 1") +
  ylab("Principal Component 2")

pca_plot_drugs12

pca_plot_drugs34 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,3], y = pca$rotation[,4])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$drug))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  #mit BREWER: scale_fill_brewer(palette = "Dark2")
  ggtitle("Principal Component Analysis - color drugs") +
  xlab("Principal Component 3") +
  ylab("Principal Component 4")

pca_plot_drugs34
```

## Colored PCA by chemo/targeted
```{r, echo=FALSE}
targeted.chemo <- c("targeted", "targeted", "chemo", "chemo", "chemo", "chemo", "chemo", "targeted", "targeted", "chemo", "chemo", "chemo", "chemo", "targeted", "chemo")
drug.added <- cbind(drug, targeted.chemo)
drug.added.ordered <- drug.added[order(drug.added$Drug),]

chem.targ = c(rep(as.numeric(0),819))
meta_neu = cbind(meta_neu, chem.targ)

i=1
j=1

while(j<16)
{while(i<820)
{
  if(isTRUE(meta_neu[i,3]== drug.added.ordered[j,1]))
  {meta_neu[i,7] = as.character(drug.added.ordered[j,9])
  }
  i = i +1
}
  i= 1
  j=j+1}
```

```{r, echo=FALSE, fig.width=4, fig.height=4, out.extra='style="float:left"'}
pca_plot_chemtarg12 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,1], y = pca$rotation[,2])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$chem.targ))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  #mit BREWER: scale_fill_brewer(palette = "Dark2")
  ggtitle("Principal Component Analysis chemo/targeted") +
  xlab("Principal Component 1") +
  ylab("Principal Component 2")

pca_plot_chemtarg12

pca_plot_chemtarg34 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,3], y = pca$rotation[,4])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$chem.targ))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  #mit BREWER: scale_fill_brewer(palette = "Dark2")
  ggtitle("Principal Component Analysis chemo/targeted") +
  xlab("Principal Component 3") +
  ylab("Principal Component 4")

pca_plot_chemtarg34
```

## Colored PCA by tyrosine kinase inhibitors

```{r, echo=FALSE}
TKI = c(rep(as.numeric(0),819))
meta_neu = cbind(meta_neu, TKI)

i=1
j=1

while(j<16)
{while(i<820)
{
  if(isTRUE(meta_neu[i,3]== drug.added.ordered[j,1])
     & (drug.added.ordered[j,3] == "Tyrosine kinase inhibitor"))
  {meta_neu[i,8] = as.character(drug.added.ordered[j,3])
  }
  i = i +1
}
  i= 1
  j=j+1}
```

```{r, echo=FALSE, fig.width=4, fig.height=4, out.extra='style="float:left"'}
pca_plot_TKI12 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,1], y = pca$rotation[,2])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$TKI))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  ggtitle("Principal Component Analysis TKI") +
  xlab("Principal Component 1") +
  ylab("Principal Component 2")

pca_plot_TKI12

pca_plot_TKI34 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,3], y = pca$rotation[,4])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$TKI))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  ggtitle("Principal Component Analysis TKI") +
  xlab("Principal Component 3") +
  ylab("Principal Component 4")

pca_plot_TKI34
```






# Specific Analysis

## Step 1: Can we identify genes as significant biomarker for cisplatin?{.smaller}
```{r, echo = F, include = F}
library(readxl)
library(gplots)
library(pheatmap)

## necessary data from the general analysis
meta <- read.delim("C:/Users/johan/Documents/Bioinfo_project/NCI_TPW_metadata.tsv", header = TRUE, sep = "\t")
treated <- readRDS("C:/Users/johan/Documents/Bioinfo_project/NCI_TPW_gep_treated.rds")
untreated <- readRDS("C:/Users/johan/Documents/Bioinfo_project/NCI_TPW_gep_untreated.rds")
copynumber <- readRDS("C:/Users/johan/Documents/Bioinfo_project/CCLE_copynumber.rds")
cellline <- read.delim("C:/Users/johan/Documents/Bioinfo_project/cellline_annotation.tsv", header = TRUE, sep = "\t")
meta = as.data.frame(meta)
celline = as.data.frame(cellline)

#scale
treated.scaled <- scale(treated)
untreated.scaled <- scale(untreated)

#FC
log2FC.treated.untreated <- (treated.scaled-untreated.scaled) #values are already log2 transformed
is.nan.data.frame <- function(x)      #NaN durch 0 ersetzen
  do.call(cbind, lapply(x, is.nan))
log2FC.treated.untreated[is.nan(log2FC.treated.untreated)] <- 0
cisplatin.col=c()
j=1

while(j<820)
{
  if(isTRUE(meta[j,3]== "cisplatin"))
  {cisplatin.col= c(cisplatin.col,j)
  }
  j = j +1
}

FC.cisplatin = log2FC.treated.untreated[,cisplatin.col]

mean.FC.genes <- apply(FC.cisplatin, 1, mean)
mean.FC.celllines <- apply(FC.cisplatin, 2, mean)
```````

````{r, echo = F, include = T, fig.width=4, fig.height=4.25, out.extra='style="float:left"'}
sd.cisplatin = apply(FC.cisplatin, 1, sd)
mean.FC.genes.sd = as.data.frame(cbind(mean.FC.genes, sd.cisplatin))
mean.FC.ordered = mean.FC.genes.sd[order(mean.FC.genes.sd$mean.FC.genes, decreasing=TRUE), ]

lowest.FC = mean.FC.ordered[13280:13299,]
par(mar = c(5, 7, 5, 5))
barplot(lowest.FC$mean.FC.genes,
        horiz = TRUE,
        xlim = c(-1.0, 0),
        main= "lowest log2 FC-values for cisplatin",
        xlab= "mean log2FC values in different celllines",
        names.arg = rownames(lowest.FC),
        col= "firebrick",
        las=1,
        border = "white", 
        cex.names =0.8)

highest.FC = mean.FC.ordered[1:20,]
par(mar = c(5, 10, 5, 5))
barplot(highest.FC$mean.FC.genes,
        horiz = TRUE,
        xlim = c(0, 1),
        main= "highest log2 FC-values for cisplatin",
        xlab= "mean log2FC values in different celllines",
        names.arg = rownames(highest.FC),
        col= "lightgreen",
        las=1,
        border = "white",
        cex.names =0.8)
``````

`````{r, echo= F}
#matrix containing the biomarker found through the FC 
highest.FC = as.matrix(highest.FC) 
lowest.FC = as.matrix(lowest.FC)
biomarker1.FC = as.matrix(rbind(highest.FC, lowest.FC))
highest.names <- row.names(highest.FC)
lowest.names <- row.names(lowest.FC)
row.names(biomarker1.FC) <- c(highest.names, lowest.names)
biomarker1 <- c(highest.names, lowest.names)
`````

```{r, echo=F}
is.neg = FC.cisplatin<0
i =1
j=1
a=1
biomarker2.up = c()
biomarker2.down = c()
while(j<13300){
  while(i<56){
    if(is.neg[j,i]==TRUE)
     {a=a+1}
    i=i+1}
  if(a>49)
     {biomarker2.down= c(biomarker2.down, j)}
  if(a<6)
    {biomarker2.up= c(biomarker2.up, j)}
  a=1
  i=1
  j=j+1}

biomarker2 = row.names(FC.cisplatin[c(biomarker2.down, biomarker2.up),])
```

##  Significance of biomarker genes
```{r, echo = F, include=T, dpi = 50}
i=1
j=1
a=1
double.biomarker = c()
while(i<41)
{
  while(j<375)
      {
        if(isTRUE(biomarker2[j] == biomarker1[i]))
           {double.biomarker = c(double.biomarker, biomarker1[a])
             }
            j = j +1
         }
          j= 1
          i=i+1
          a=a+1
}

double.biomarker.FC = FC.cisplatin[double.biomarker,]
double.biomarker
```
```{r, echo = F}
treated.cisplatin <- treated.scaled[,grep ("cisplatin", colnames(treated.scaled))]
untreated.cisplatin <- untreated.scaled[,grep("cisplatin", colnames(treated.scaled))]
```
````{r, echo = F, include = T, fig.width=4, fig.height=4, out.extra='style="float:left"'}
pvalues.welch <- sapply(double.biomarker, function(x){
       t.test(treated.cisplatin[x,], untreated.cisplatin[x,],paired= T)$p.value
   })
plot(density(pvalues.welch), main = "Welch two sample t-test: density of p values")
``````




```{r, echo = F, include = T, fig.height=4, fig.width=4, out.extra=' style="clear: both;'}
# checking consistency with standard deviation for double.biomarker
mean.double <- apply(double.biomarker.FC, 1, mean)
sd.double <- apply(double.biomarker.FC, 1, sd)
double = cbind(mean.double, sd.double)
colnames(double) = c("mean FC","SD" )
double
```

## Step 2: Influence of cisplation on the biomarkers gene expression

```{r, echo = F}
colfunc <- colorRampPalette(c("firebrick","firebrick3","lightcoral", "lightyellow","lightskyblue1","steelblue1","steelblue3", "darkblue"))
```
```{r dpi = 100, echo = F}
colnames(double.biomarker.FC) <- meta[95:149,2]
annotation = data.frame(Cancertype = cellline$Cancer_type)
rownames(annotation) = cellline$Cell_Line_Name

pheatmap(double.biomarker.FC,
         color = colfunc(25),
         cluster_cols = TRUE,
         clustering_rows = TRUE,
         clustering_method ="ward.D2",
         treeheight_row = 30,
         treeheight_col = 30,
         annotation_col = annotation,
         legend = T,
         legend_breaks = c(-1,1),
         legend_labels = c("down", "up"),
         show_colnames = F,
         cutree_rows = 2,
         cutree_cols = 4,
         border_color = "white",
         scale = "column")
```

## Step 3: Further analysis of biomarker
```{r, echo = F}
copynumber.biomarker = as.matrix(copynumber[double.biomarker,])
copynumber.quali = ifelse(copynumber.biomarker <= (-1), (-1), ifelse (copynumber.biomarker >= (1), 1, 0))
```
Connection between biomarker and gene alterations

```{r, echo = F, include = T, dpi = 100}
colfunc2 <- colorRampPalette(c("firebrick2", "grey88", "deepskyblue3"))

colnames(double.biomarker.FC) <- meta[95:149,2]
annotation = data.frame(Cancertype = cellline$Cancer_type)
rownames(annotation) = cellline$Cell_Line_Name

pheatmap(copynumber.quali,
         color = colfunc2(3),
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         clustering_method = "ward.D2",
         legend = TRUE,
         legend_breaks = c(-1,0,1),
         legend_labels = c("deletion","", "amplification"),
         border_color = "white",
         show_colnames = FALSE,
         cutree_rows = 4,
         cutree_cols = 4,
         treeheight_row = 20,
         treeheight_col = 20,
         annotation = annotation)
```

































# RGES
## Reverse gene expression score
![](C:/Users/johan/Documents/GitHub/project-02-group-02/data/Schaubild_RGES.png)












































# Further Analysis
## Overview of our RGES - results
```{r, include = FALSE}
results <- readRDS("C:/Users/johan/Documents/Bioinfo_project/results.rds")
results_cisplatin = subset (results , drug == "cisplatin")
``` 

```{r, echo= FALSE, include= FALSE}
quantile(results$RGES)
quantile(results_cisplatin$RGES)
min = min(results$RGES)
max = max(results$RGES)
```
  
```{r, echo=FALSE, fig.width=4, fig.height=4, out.extra='style="float:left"'}
quantile.res = as.matrix(quantile(results$RGES))
plot(density(results$RGES), main ="Distribution RGES values")
abline(v= quantile.res[c(2,4),1], col= c("red", "blue"), lty =2)
legend(-6, 1.2, legend = c("25 % quantile", "75% quantile"), col = c("red", "blue"), lty = 1:2)
quantile.cis = as.matrix(quantile(results_cisplatin$RGES))
plot(density(results_cisplatin$RGES), main = "Distribution RGES values cisplatin")
abline(v= quantile.cis[c(2,4),1], col= c("red", "blue"), lty =2)
legend(-6, 1.2, legend = c("25 % quantile", "75% quantile"), col = c("red", "blue"), lty = 1:2)
```  

## Mean RGES values from cisplatin in different tissues
```{r, echo = FALSE}
tissue = c( "Renal", "Lung" , "Breast" , "Colon", "Prostate" , "Leukemia", "Ovarian", "Melanoma", "CNS")
mean_tissue =sapply(1:length(tissue), function(x) mean(subset(results_cisplatin$RGES , tissue == tissue[x])))
barplot(mean_tissue , name = tissue , las = 2 , horiz = FALSE ,col= "firebrick", border = "white" , main = "mean RGES for cisplatin in different tissues" , ylab = "RGES")
nrow(min(results_cisplatin$RGES))
```

## Mean RGES values for different drugs
```{r, echo=FALSE}
drug = c("5-Azacytidine", "bortezomib", "cisplatin","dasatinib","doxorubicin","erlotinib","geldanamycin","gemcitibine","lapatinib","paclitaxel","sirolimus","sorafenib","sunitinib","topotecan","vorinostat")
mean_drug =sapply(1:length(drug), function(x) mean(subset(results$RGES , drug == drug[x])))
barplot(mean_drug , name = drug , las = 2 , horiz = FALSE ,col= "forestgreen", border = "white" , main = "mean RGES for different drugs" , ylab = "RGES")
```

















































# Linear Regression Analysis

## Correlation between our RGES values and Drug Sensitivity?
```{r, echo=FALSE}
### load the data
drug_activity_rges <- readRDS("C:/Users/johan/Documents/Bioinfo_project/drug_activity_rges.rds") 

# limit the data set to numerical values, convert IC50 values as they are in -log10 scale
#keine ahnung ob das sinn macht, was ich hier getan habe?
ic50 = drug_activity_rges[,9]
IC50.value = -10^ic50
RGES = drug_activity_rges[,2]
rges.ic50 <- as.data.frame(cbind(RGES, IC50.value))
```
Correlation coefficient:
```{r, echo = FALSE, include = TRUE}
cor(rges.ic50$RGES, rges.ic50$IC50.value)
```
```{r,echo=FALSE, include=TRUE, dpi=75, warning=FALSE}
library(ggplot2)
ggplot(rges.ic50, aes(rges.ic50$RGES, rges.ic50$IC50.value)) +
  geom_point(color = "blue", size = 1) +
  scale_size(range = c(2,5)) +
  xlab("RGES") + 
  ylab("Drug Sensitivity") +
  xlim(0.1,0.25)+
  ylim(-1e+09,0.2e+09)
```

## Predict Drug Sensitivity with RGES? (1)

```{r, echo = FALSE}
i.train = sample(1:nrow(rges.ic50), 730)
## 
rges.ic50.train = rges.ic50[i.train, ]
rges.ic50.test = rges.ic50[-i.train, ]
```
```{r, echo = FALSE, include=TRUE}
lm.rges_ic50 = lm(IC50.value ~ RGES, data = rges.ic50.train)
summary(lm.rges_ic50)
```

## Predict Drug Sensitivity with RGES? (2)
Root mean square error:
```{r, echo = FALSE}
#compute RMSE
pred = predict(lm.rges_ic50, newdata = rges.ic50.test)
n = nrow(rges.ic50.train)
rmse.train = sqrt(1/n * sum(lm.rges_ic50$residuals^2))
n = nrow(rges.ic50.test)
residuals = rges.ic50.test$IC50.value - pred
rmse.test = sqrt(1/n * sum(residuals^2))
```
```{r,echo=FALSE, include=TRUE}
rmse.test
```
```{r, echo = FALSE, include=TRUE, dpi=80}
plot(rges.ic50.test$IC50.value, pred, xlab = "Real Values", ylab = "Predicted Values", pch=20, col="blue")
abline(0, 1, col = "red")
```

## Enhance model: Multiple Regression (Cisplatin)
```{r, echo=FALSE}
#Multiple Regression
# 1. Include biomarkers to RGES matrix only for cisplatin!
double.biomarker.FC <- readRDS("C:/Users/johan/Documents/Bioinfo_project/double.biomarker.FC.rds")
drug_activity_rges.cisplatin = subset (drug_activity_rges , drug == "cisplatin")
# transformieren, damit samples in zeile
biomarker.FC = t(double.biomarker.FC)

# Problem: dimensionen der matrizen unterschiedlich, drugactivity eine zeile weniger als biomarker.FC scheinbar in Zeile 26 unterschiedlich?
# Anpassen der beiden matrizen aneindander:
biomarker.FC.fit = subset(biomarker.FC, rownames(biomarker.FC) %in% drug_activity_rges.cisplatin$sample)
results_biomarkers = cbind(drug_activity_rges.cisplatin, biomarker.FC.fit)

# limit the data set to numerical values: rges, ic50 and biomarkers:
# ic50 values are in -log10 scale
ic50.cisplatin = drug_activity_rges.cisplatin[,9]
IC50.value.cisplatin = 10^-(ic50.cisplatin)
RGES.cisplatin = drug_activity_rges.cisplatin[,2]
rges.ic50.biomarkers <- as.data.frame(cbind(RGES.cisplatin, IC50.value.cisplatin,biomarker.FC.fit))
```

- **+** Previously found biomarkers

```{r, echo = F, include = T}
print(colnames(biomarker.FC.fit))
```

## Correlation IC50, RGES and Biomarkers?
Heatmap Correlation RGES, Drug Sensitivity, Biomarkers
```{r, echo=FALSE, include=TRUE}
cor = cor(rges.ic50.biomarkers)
heatmap(cor, col = cm.colors(256))
```

## Predict Drug Sensitivity these Variables? (1)
```{r, echo = FALSE}
# multiple regression model
# create training and test set
train.multiple = sample(1:nrow(rges.ic50.biomarkers), 45)
## 
train.set.multiple = rges.ic50.biomarkers[train.multiple, ]
test.set.multiple = rges.ic50.biomarkers[-train.multiple, ]
```
```{r, echo=FALSE, include=TRUE}
model.multiple = lm(IC50.value.cisplatin ~ ., data = train.set.multiple)
summary(model.multiple)
```

## Predict Drug Sensitivity with RGES and Biomarkers? (2)
```{r, echo = FALSE}
predict.multiple = predict(model.multiple, newdata = test.set.multiple)
```
```{r, echo=FALSE}
n = nrow(train.set.multiple)
rmse.train = sqrt(1/n * sum(model.multiple$residuals^2))
n = nrow(test.set.multiple)
residuals = test.set.multiple$IC50.value.cisplatin - predict.multiple
rmse.test = sqrt(1/n * sum(residuals^2))
```
Root mean square error: 
```{r, echo=FALSE, include=TRUE}
rmse.test
```
```{r, echo=FALSE, include=TRUE, dpi=75}
plot(test.set.multiple$IC50.value.cisplatin, predict.multiple, xlab = "Real Values", ylab = "Predicted Values", pch=20, col="blue")
abline(0, 1, col = "red")
```

## Enhance model: Specific biomarkers

- High correlation with drug sensitivity

- Low correlation between eachother

- --> GMDS, LRBA, ATXN1

## Predict Drug Sensitivity with specific biomarkers? (1)
```{r, echo = FALSE, include=TRUE}
model.multiple.biomarkers = lm(IC50.value.cisplatin ~ GMDS + LRBA + ATXN1, data = train.set.multiple)
summary(model.multiple.biomarkers)
```

## Predict Drug Sensitivity with specific biomarkers? (2)
```{r, echo = FALSE, include=TRUE}
predict.biomarkers = predict(model.multiple.biomarkers, newdata = test.set.multiple)
```
```{r, echo=FALSE}
n = nrow(train.set.multiple)
rmse.train = sqrt(1/n * sum(model.multiple.biomarkers$residuals^2))
n = nrow(test.set.multiple)
residuals = test.set.multiple$IC50.value.cisplatin - predict.biomarkers
rmse.test = sqrt(1/n * sum(residuals^2))
```
Root mean square error:
```{r, echo = FALSE, include = TRUE}
rmse.test
```
```{r, echo=FALSE, include=TRUE, dpi=80}
plot(test.set.multiple$IC50.value.cisplatin, predict.biomarkers, xlab = "Real Values", ylab = "Predicted Values", pch=20, col="blue")
abline(0, 1, col = "red")
```


