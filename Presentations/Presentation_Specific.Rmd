---
title: "Specific Analysis"
date: "7/19/2019"
output: html_document
---
`````{r, include = F}
library(readxl)
library(gplots)
library(pheatmap)
library(VennDiagram)

## necessary data from the general analysis
meta <- read_excel("~/Documents/Uni/4.Semester/Bioinfo/GitHub/project-02-group-02/data/NCI_TPW_metadata.xls")
untreated <- readRDS("~/Documents/Uni/4.Semester/Bioinfo/GitHub/project-02-group-02/data/NCI_TPW_gep_untreated.rds")
treated <- readRDS("~/Documents/Uni/4.Semester/Bioinfo/GitHub/project-02-group-02/data/NCI_TPW_gep_treated.rds")
copynumber <- readRDS("~/Documents/Uni/4.Semester/Bioinfo/GitHub/project-02-group-02/data/CCLE_copynumber.rds")
cellline <- read_excel("~/Documents/Uni/4.Semester/Bioinfo/GitHub/project-02-group-02/data/cellline_annotation.xls")
meta = as.data.frame(meta)
celline = as.data.frame(cellline)

#scale
treated.scaled <- scale(treated)
untreated.scaled <- scale(untreated)

log2FC.treated.untreated <- (treated.scaled-untreated.scaled)

cisplatin.col=c()
j=1

while(j<820)
{
  if(isTRUE(meta[j,3]== "cisplatin"))
  {cisplatin.col= c(cisplatin.col,j)
  }
  j = j +1
}

FC.cisplatin = log2FC.treated.untreated[,cisplatin.col]

mean.FC.genes <- apply(FC.cisplatin, 1, mean)
mean.FC.celllines <- apply(FC.cisplatin, 2, mean)

`````

## Step 1: Can we identify certain genes as biomarkers for cisplatin? <a name="step1"></a> 

### Criterium: High fold-change values throughout the cell lines
````{r, echo = F, include = T, fig.width= 4.5, fig.height = 5, fig.show = 'hold'}
sd.cisplatin = apply(FC.cisplatin, 1, sd)
mean.FC.genes.sd = as.data.frame(cbind(mean.FC.genes, sd.cisplatin))
mean.FC.ordered = mean.FC.genes.sd[order(mean.FC.genes.sd$mean.FC.genes, decreasing=TRUE), ]

lowest.FC = mean.FC.ordered[13280:13299,]
par(mar = c(5, 7, 5, 5))
barplot(lowest.FC$mean.FC.genes,
        horiz = TRUE,
        xlim = c(-1.0, 0),
        main= "lowest log2 FC-values",
        xlab= "mean log2FC values in different celllines",
        names.arg = rownames(lowest.FC),
        col= "firebrick",
        las=1,
        border = "white", 
        cex.names =0.8)

highest.FC = mean.FC.ordered[1:20,]
par(mar = c(5, 10, 5, 5))
barplot(highest.FC$mean.FC.genes,
        horiz = TRUE,
        xlim = c(0, 1),
        main= "highest log2 FC-values",
        xlab= "mean log2FC values in different celllines",
        names.arg = rownames(highest.FC),
        col= "lightgreen",
        las=1,
        border = "white",
        cex.names =0.8)
``````

`````{r, echo= F}
#matrix containing the biomarker found through the FC 
highest.FC = as.matrix(highest.FC) 
lowest.FC = as.matrix(lowest.FC)
biomarker1.FC = as.matrix(rbind(highest.FC, lowest.FC))
highest.names <- row.names(highest.FC)
lowest.names <- row.names(lowest.FC)
row.names(biomarker1.FC) <- c(highest.names, lowest.names)
biomarker1 <- c(highest.names, lowest.names)
`````

```{r, echo=F}
is.neg = FC.cisplatin<0
i =1
j=1
a=1
biomarker2.up = c()
biomarker2.down = c()
while(j<13300){
  while(i<56){
    if(is.neg[j,i]==TRUE)
     {a=a+1}
    i=i+1}
  if(a>49)
     {biomarker2.down= c(biomarker2.down, j)}
  if(a<6)
    {biomarker2.up= c(biomarker2.up, j)}
  a=1
  i=1
  j=j+1}
```

````{r, echo =F}
biomarker2 = row.names(FC.cisplatin[c(biomarker2.down, biomarker2.up),])
`````

<br/>

```{r, echo = F, include=TRUE}
i=1
j=1
a=1
double.biomarker = c()
while(i<41)
{
  while(j<375)
      {
        if(isTRUE(biomarker2[j] == biomarker1[i]))
           {double.biomarker = c(double.biomarker, biomarker1[a])
             }
            j = j +1
         }
          j= 1
          i=i+1
          a=a+1
}

double.biomarker.FC = FC.cisplatin[double.biomarker,]

```
### Additional criterium: Gene expression change in the same "direction"
--> Consistent up- or down regulation of genes 

`````{r, echo = F, include = T, fig.align = 'center'}
grid.newpage()
venn.plot <- draw.pairwise.venn(
  area1 = 40,
  area2 = 668,
  cross.area = 15,
  fill = c("yellowgreen", "steelblue2"),
  category = c("FC-Criterium", "Consistent up- or downregulation"),
  lty = "blank",
  cex = 2,
  cat.cex = 1.5,
  cat.pos = c(0, 3),
  cat.dist = -0.5,
  cat.just = list(c(-0.0, 11), c(1,1.5)),
  cat.col = c("yellowgreen", "steelblue2"), 
  ext.pos = c(-3,2),
  ext.dist = c(-0.4, -0.05),
  ext.length = 0.8
)
grid.draw(venn.plot)
```````

````{r, echo = T}
print(double.biomarker)
````
### How significant are the genes identified as biomarkers?
```{r, echo = F}
treated.cisplatin <- treated.scaled[,grep ("cisplatin", colnames(treated.scaled))]
untreated.cisplatin <- untreated.scaled[,grep("cisplatin", colnames(treated.scaled))]
```


````{r dpi =90, echo =F, include = T, fig.width= 5, fig.height = 5, out.extra='style="float:left"'}
pvalues.welch <- sapply(double.biomarker, function(x){
       t.test(treated.cisplatin[x,], untreated.cisplatin[x,],paired= T)$p.value
   })
plot(density(pvalues.welch), main = "P-values welch t-test")
````

<br/>

#### Standard deviation
```{r, echo = F, include = T}
mean.double <- apply(double.biomarker.FC, 1, mean)
sd.double <- apply(double.biomarker.FC, 1, sd)
double = cbind(mean.double, sd.double)
colnames(double) = c("mean FC","SD" )
print(double)
```

````{r, echo = F, include= F}
sd.cisplatin = apply(FC.cisplatin, 1, sd)
mean.FC.genes.sd = as.data.frame(cbind(mean.FC.genes, sd.cisplatin))
mean.FC.ordered = mean.FC.genes.sd[order(mean.FC.genes.sd$mean.FC.genes, decreasing=TRUE), ]
head(mean.FC.genes.sd)
plot(density(sd.cisplatin))
```

<br/>
<br/>

<br/>
<br/>

<br/>
<br/>

## Step 2: Influence of cisplatin on the biomarkers gene expression in different cell lines

<br/>

````{r, echo = F}
colfunc <- colorRampPalette(c("firebrick","firebrick3","lightcoral",
                              "lightyellow","lightskyblue1","steelblue1",
                              "steelblue3", "darkblue"))
`````
```{r echo = F, include = T, dpi = 200, fig.align='center'}
colnames(double.biomarker.FC) <- meta[95:149,2]
annotation = data.frame(Cancertype = cellline$Cancer_type)
rownames(annotation) = cellline$Cell_Line_Name

pheatmap(double.biomarker.FC,
         color = colfunc(25),
         cluster_cols = TRUE,
         clustering_rows = TRUE,
         clustering_method ="ward.D2",
         treeheight_row = 30,
         treeheight_col = 30,
         annotation_col = annotation,
         legend = T,
         legend_breaks = c(-1,1),
         legend_labels = c("down", "up"),
         show_colnames = F,
         cutree_rows = 2,
         cutree_cols = 4,
         border_color = "white",
         scale = "column")
```
<br/>

## Step 3: Further analysis of the biomarkers  

```{r echo = F}
copynumber.biomarker = as.matrix(copynumber[double.biomarker,])
```

<br/>
Gene amplification or deletion: 

````{r}
copynumber.quali = ifelse(copynumber.biomarker <= (-1), (-1), ifelse (copynumber.biomarker >= (1), 1, 0))
````
<br/>

````{r fig.align = 'right', echo = F, include = T, dpi = 160}
colfunc2 <- colorRampPalette(c("firebrick2", "grey88", "deepskyblue3"))

colnames(double.biomarker.FC) <- meta[95:149,2]
annotation = data.frame(Cancertype = cellline$Cancer_type)
rownames(annotation) = cellline$Cell_Line_Name

pheatmap(copynumber.quali,
         color = colfunc2(3),
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         clustering_method = "ward.D2",
         legend = TRUE,
         legend_breaks = c(-1,0,1),
         legend_labels = c("deletion","", "amplification"),
         border_color = "white",
         show_colnames = FALSE,
         cutree_rows = 4,
         cutree_cols = 3,
         treeheight_row = 20,
         treeheight_col = 20,
         annotation = annotation)
````

