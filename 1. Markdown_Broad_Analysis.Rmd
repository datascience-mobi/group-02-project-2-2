---
title: "1. Broad Analysis"
date: "5 Juni 2019"
output:
  html_document: default
  pdf_document: default
---
The goal of this broad analysis is to gain an overview of the given datasets containing the influence of different drugs to the cellular response. This will be the basis for all next investigations, containing one specific drug - cisplatin. 



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
library(viridis)
library(ggplot2)
```
## Table of content
1. [Loading Data](#loaddata)
2. [Cleaning up our data](#cleanup)
    2.1 [Remove NAs](#removeNA)
    2.2 [Scaling](#scale)
3. [Boxplots](#boxplots)
    3.1 [Boxplot treated without scaling](#boxwithoutscaling)
    3.2 [Boxplot treated with scaling](#boxwithscaling)
4. [Foldchange](#fc)
5. [PCA](#pca)
    5.1 [Explained Variance](#variance)
    5.2 [PCA - coloring every drug](#coldrug)
    5.3 [PCA - coloring chemo/targeted](#colchemtarg)
    5.4 [PCA - coloring tyrosine kinase inhibitor](#colTKI)


## 1. Load Data <a name="loaddata"></a>
The given data is integrated as follows:
```{r}
treated <- readRDS("C:/Users/johan/Documents/Bioinfo_project/NCI_TPW_gep_treated.rds")
untreated <- readRDS("C:/Users/johan/Documents/Bioinfo_project/NCI_TPW_gep_untreated.rds")
ic50 <- readRDS("C:/Users/johan/Documents/Bioinfo_project/NegLogGI50.rds")
basalexp <- readRDS("C:/Users/johan/Documents/Bioinfo_project/CCLE_basalexpression.rds")
copynumber <- readRDS("C:/Users/johan/Documents/Bioinfo_project/CCLE_copynumber.rds")
mutations <- readRDS("C:/Users/johan/Documents/Bioinfo_project/CCLE_mutations.rds")
cellline <- read.delim("C:/Users/johan/Documents/Bioinfo_project/cellline_annotation.tsv", header = TRUE, sep = "\t")
meta <- read.delim("C:/Users/johan/Documents/Bioinfo_project/NCI_TPW_metadata.tsv", header = TRUE, sep = "\t")
drug <- read.delim("C:/Users/johan/Documents/Bioinfo_project/drug_annotation.tsv", header = TRUE, sep = "\t")
```
## 2. Ceaning up our data <a name="cleanup"></a>
### 2.1 Remove NAs <a name="removeNA"></a>
In order to clean up our data, we created a loop for checking the amount of NAs in every matrix. Then, two coloumns, which only contained NAs were deleated out of the mutations matrix.
```{r}
list.na = list("treated"=treated, "untreated"=untreated, "mutations"=mutations, "basalexp" = basalexp, "cellline"=cellline, "copynumber"=copynumber, "ic50"=ic50, "meta"=meta)
myfunc = function(x){sum(is.na(x))}

i = 0
while(i<9)
{
  p=sapply(list.na[i],myfunc)
  print(p)
  i = i +1
}

mutations.removed = mutations[, -(12:13)]
```

### 2.2 Scaling <a name="scale"></a>
For normalizing our data, scale was used. 
```{r}
#scale
basal.scaled <- scale(basalexp)
treated.scaled <- scale(treated)
untreated.scaled <- scale(untreated)
```


## 3. Boxplots <a name="boxplots"></a>
### 3.1 Boxplot treated without scaling <a name="boxwithoutscaling"></a>
In order to get an overview a boxplot of the treated data was computed. There was a visible difference between the 15 batches. Each drug was colored in a different color.

```{r}
drug15 = meta$drug
palette(viridis(15))

par(mar=c(5, 4, 5, 9))
boxplot(treated, medcol="black", border = drug15, col= drug15, 
         xlab="sampels", ylab="gene expression",
         main= "Gene expression treated - colored by drugs",
         names= FALSE, xaxt= "n", boxwex=1, boxlty =0)
```


### 3.2 Boxplot treated with scaling <a name="boxwithscaling"></a>
Through scaling the data the different batches dissapeared.

```{r}
palette(viridis(15))

par(mar=c(5, 4, 5, 9))
boxplot(treated.scaled, medcol="black", border = drug15, col= drug15, 
         xlab="sampels", ylab="gene expression",
         main= "Scaled gene expression treated - colored by drugs",
         names= FALSE, xaxt= "n", boxwex=1, boxlty =0)
```



## 4. Computation of the Fold Change - Treated/Untreated <a name="fc"></a>
In order to analyse the gene expression change from untreated to treated, log2 fold change values were computed. The distribution was checked through a density plot. The values are located near to 0. 
```{r}
log2FC.treated.untreated <- treated.scaled - untreated.scaled
is.nan.data.frame <- function(x)      #NaN durch 0 ersetzen
  do.call(cbind, lapply(x, is.nan))
log2FC.treated.untreated[is.nan(log2FC.treated.untreated)] <- 0
plot(density(log2FC.treated.untreated), main = "Log2 FC Treated/Untreated")
```

## 5. PCA <a name="pca"></a>
For a dimensionallity reduction, a principal component analysis was performed. The PCA was interpreted by plotting the first four components in different plots, and coloring different groups of data.
First chemotherapeutics and targeted drugs were colored in both plots. This did not seperate the data in visible groups. 
Next each drug was colored in a different color, the color scheme remained the same as bevore. Here PC3 and PC4 seem to seperate the diffenrent drugs. Especially vorinostat was seperated from the rest of the data.
Lastly 4 tyrosine kinase inhibitors drugs were colored. There was no seperation visible in PC1 and PC2, in the plot with PC3 and PC4 the Tyrosin Kinases seem to concentrate at a point.
```{r}
PCA.FC <- prcomp(log2FC.treated.untreated, center=F , scale.=F)
plot(PCA.FC, type ="lines")
plot(PCA.FC$rotation[, 1], PCA.FC$rotation[, 2], xlab = "PC1", ylab = "PC2", pch=19, main = "PCA Treated/Untreated")
plot(PCA.FC$rotation[, 3], PCA.FC$rotation[, 4], xlab = "PC3", ylab = "PC4", pch = 19, main = "Treated/Untreated")
```

### 5.1 How many variance can be explained by the principle components? <a name="variance"></a>
```{r}
Varianz.PCA=PCA.FC$sdev^2
Varianz.PCA
```

### 5.2 Colored PCA (drugs) <a name="coldrug"></a>
```{r}
pca = prcomp(log2FC.treated.untreated)

meta_neu = meta[1:819,]
meta_neu = as.data.frame(meta_neu)
```

#### Plot PC1 and PC2
```{r} 
pca_plot_drugs12 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,1], y = pca$rotation[,2])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$drug))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  #mit BREWER: scale_fill_brewer(palette = "Dark2")
  ggtitle("Principal Component Analysis 1 & 2") +
  xlab("Principal Component 1") +
  ylab("Principal Component 2")

pca_plot_drugs12
```
#### Plot PC3 and PC4
```{r}

pca_plot_drugs34 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,3], y = pca$rotation[,4])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$drug))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  #mit BREWER: scale_fill_brewer(palette = "Dark2")
  ggtitle("Principal Component Analysis 3 & 4") +
  xlab("Principal Component 3") +
  ylab("Principal Component 4")

pca_plot_drugs34
```
### 5.3 Colored PCA chemo/targeted <a name="colchemtarg"></a>
```{r}

targeted.chemo <- c("targeted", "targeted", "chemo", "chemo", "chemo", "chemo", "chemo", "targeted", "targeted", "chemo", "chemo", "chemo", "chemo", "targeted", "chemo")
drug.added <- cbind(drug, targeted.chemo)
drug.added.ordered <- drug.added[order(drug.added$Drug),]

chem.targ = c(rep(as.numeric(0),819))
meta_neu = cbind(meta_neu, chem.targ)

i=1
j=1

while(j<16)
{while(i<820)
{
  if(isTRUE(meta_neu[i,3]== drug.added.ordered[j,1]))
  {meta_neu[i,7] = as.character(drug.added.ordered[j,9])
  }
  i = i +1
}
  i= 1
  j=j+1}
```

#### Plot PC1 and PC2
```{r}

pca_plot_chemtarg12 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,1], y = pca$rotation[,2])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$chem.targ))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  #mit BREWER: scale_fill_brewer(palette = "Dark2")
  ggtitle("Principal Component Analysis 1&2") +
  xlab("Principal Component 1") +
  ylab("Principal Component 2")

pca_plot_chemtarg12
```
#### Plot PC3 and PC4
```{r}
pca_plot_chemtarg34 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,3], y = pca$rotation[,4])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$chem.targ))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  #mit BREWER: scale_fill_brewer(palette = "Dark2")
  ggtitle("Principal Component Analysis 3&4") +
  xlab("Principal Component 3") +
  ylab("Principal Component 4")

pca_plot_chemtarg34
```

### 5.4 Colored PCA tyrosine kinase inhibitor <a name="colTKI"></a>
```{r}

TKI = c(rep(as.numeric(0),819))
meta_neu = cbind(meta_neu, TKI)

i=1
j=1

while(j<16)
{while(i<820)
{
  if(isTRUE(meta_neu[i,3]== drug.added.ordered[j,1])
     & (drug.added.ordered[j,3] == "Tyrosine kinase inhibitor"))
  {meta_neu[i,8] = as.character(drug.added.ordered[j,3])
  }
  i = i +1
}
  i= 1
  j=j+1}
```

#### Plot PC1 and PC2
```{r}
pca_plot_TKI12 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,1], y = pca$rotation[,2])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$TKI))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  ggtitle("Principal Component Analysis 1&2") +
  xlab("Principal Component 1") +
  ylab("Principal Component 2")

pca_plot_TKI12
```
#### Plot PC3 and PC4
```{r}
pca_plot_TKI34 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,3], y = pca$rotation[,4])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$TKI))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  ggtitle("Principal Component Analysis 3&4") +
  xlab("Principal Component 3") +
  ylab("Principal Component 4")

pca_plot_TKI34
```