---
title: "Linear Regression"
author: "Dorothee Mersch"
date: "8 Juli 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Linear Regression Analysis

## 1. Linear Regression Model: Drug Sensitivity - RGES

The RGES values of the paper (QUELLE) positively correlate with drug sensitivity. It is checked, whether the previously computed RGES values also correlate with the IC50 data. 
Afterwards a linear regression model is performed in order to predict drug sensitivity of various cell lines with RGES values. RGES is a value, which measures the drugs potency to reverse a disease induced gene expression.


First the data set was limited to numerical values, as well as the drug sensitivity values were converted as they were in -log10 scale.
A data frame with RGES and IC50 values is contained.
```{r, echo=FALSE}
### load the data
drug_activity_rges <- readRDS("C:/Users/Dori/Desktop/Studium/SS_19/Bioinfo Projekt/GitHub/project-02-group-02#project-02-group-02/data/drug_activity_rges.rds")


# limit the data set to numerical values, convert IC50 values as they are in -log10 scale
#keine ahnung ob das sinn macht, was ich hier getan habe?
ic50 = drug_activity_rges[,9]
IC50.value = -10^ic50
RGES = drug_activity_rges[,2]
rges.ic50 <- as.data.frame(cbind(RGES, IC50.value))
```

### Correlation Drug Sensitivity - RGES

As a next step the correlation between the computed RGES values and our drug sensitivity values is checked.
Correlation coefficient Drug Sensitivity - RGES:
```{r, echo = FALSE, include = TRUE}
cor(rges.ic50$RGES, rges.ic50$IC50.value)
```

Result of significance check:
```{r, echo=FALSE, include=TRUE}
cor.test(rges.ic50$RGES, rges.ic50$IC50.value)
```

RGES values can also be plotted against the drug sensitivity values in order to visualize the correlation.
```{r,echo=FALSE, include=TRUE}
library(ggplot2)
ggplot(rges.ic50, aes(rges.ic50$RGES, rges.ic50$IC50.value)) +
  geom_point(color = "blue", size = 1) +
  scale_size(range = c(2,5)) +
  xlab("RGES") + 
  ylab("IDrug Sensitivity") +
  xlim(0.1,0.25)+
  ylim(-1e+09,0.2e+09)
```

### Discussion
The correlation coefficient as well as the plot of RGES values against the drug sensitivity values are not really convincing. A possible reason could be, that the RGES values illustrate the drugs potentcy to reverse the cancer induced gene expression. Most of the analysed drugs are chemotherapy agents and do not interact with gene expression. 
Nevertheless it will be tried to compute a linear regression model and predict the drug sensitivity values by the previously computed RGES values. 

### Computation of the linear regression model
The linear regression model should be learned on a training set. The training set is formed by 730 random variables of the data set (correspond to ~90 % of the whole data set). The other part of the data set than is called test set. 
It was checked, whether the residuals are normal distributed and whether they correlate with x-values.

```{r, echo = FALSE}
i.train = sample(1:nrow(rges.ic50), 730)
## 
rges.ic50.train = rges.ic50[i.train, ]
rges.ic50.test = rges.ic50[-i.train, ]
```


#### Result of the linear regression model: Drug Sensitivity - RGES:

```{r, echo = FALSE, include=TRUE}
lm.rges_ic50 = lm(IC50.value ~ RGES, data = rges.ic50.train)
summary(lm.rges_ic50)
```

Interpreting the output, the R squared value shows, that only 0.7 percent of of the variance can be explained by the model. In contrast, the F-statistic suggest, that the model is at least better than taking the mean of the drug sensitivity values. Also the p-value (0.0111) shows, that the intercept could not be 0. 
In summary, the model does not convince at all as less than 1 percent of the variance can be explained.

To visiualize the model, the residuals can be plotted against the fitted values. A normal Quantile-Quantile plot was performed, in order to check the normal distribution of the residuals.

```{r, echo=FALSE, include=TRUE}
plot(lm.rges_ic50, which = c(1), pch=20, col="blue", main = "Scatter plot Residuals - Fitted values")
plot(lm.rges_ic50, which = c(2), pch=20, col="blue", main = "QQ plot Residuals")
```

Through the first plot, it can be proved, whether the residuals have non-linear patterns. As the dots look more or less equally spread around the red line, there are no non-linear relationships.
Furthernmore, the QQ plot indicates a normal distribution of residuals.

To check, that the residuals do not correlate with x, the correlation between RGES and residuals is computed.
Correlation coefficient Residuals - RGES:
```{r, echo=FALSE, include=TRUE}
cor(rges.ic50.train$RGES, lm.rges_ic50$residuals)
```
The low value can be interpreted as no correlation between RGES and residuals.


### Prediction of the data

Finally the training set was used to predict drug sensitivity with RGES values.
```{r, echo = FALSE, include=TRUE}
pred = predict(lm.rges_ic50, newdata = rges.ic50.test)
plot(rges.ic50.test$IC50.value, pred, xlab = "Real Values", ylab = "Predicted Values", pch=20, col="blue")
abline(0, 1, col = "red")
```

It can be clearly seen, that the presented values are much higher than expected. This indicated a very bad linear regression model. 

#### Validity of the model 
In order to indicate how well the model fit to the real data, the root mean square error (RMSE) can be computed. 
```{r, echo = FALSE}
#compute RMSE
n = nrow(rges.ic50.train)
rmse.train = sqrt(1/n * sum(lm.rges_ic50$residuals^2))
n = nrow(rges.ic50.test)
residuals = rges.ic50.test$IC50.value - pred
rmse.test = sqrt(1/n * sum(residuals^2))
```
For the training set, following RMSE is obtained:
```{r, echo = FALSE, include=TRUE}
rmse.train
```
And for the test set:
```{r,echo=FALSE, include=TRUE}
rmse.test
```

The lower the RMSE, the better is the linear regression model. 
All in all, itc can be concluded, that the RGES values do not have the potential to predict the drug sensitivity values. Only a very small proportion of the variablity can be explained by the model and the prediction results in different values than expected.
Due to these aspects, the univariate linear regression will be expanded. It will be checked, whether an inclusion of more variables could enhance the model.



## 2. Multiple Regression Model Cisplatin
### Variabels: RGES and biomarkers

In order to obtain an enhanced model, a multiple regression for cisplatin is performed. The previously computed biomarkers for cisplatin are included. Then drug sensitivity is predicted with RGES values, as well as with genes which showed the highest constant fold change values.
```{r, echo=FALSE}
#Multiple Regression
# 1. Include biomarkers to RGES matrix only for cisplatin!
double.biomarker.FC <- readRDS("C:/Users/Dori/Desktop/Studium/SS_19/Bioinfo Projekt/GitHub/project-02-group-02#project-02-group-02/data/double.biomarker.FC.rds")
drug_activity_rges.cisplatin = subset (drug_activity_rges , drug == "cisplatin")
# transformieren, damit samples in zeile
biomarker.FC = t(double.biomarker.FC)

# Problem: dimensionen der matrizen unterschiedlich, drugactivity eine zeile weniger als biomarker.FC scheinbar in Zeile 26 unterschiedlich?
# Anpassen der beiden matrizen aneindander:
biomarker.FC.fit = subset(biomarker.FC, rownames(biomarker.FC) %in% drug_activity_rges.cisplatin$sample)
results_biomarkers = cbind(drug_activity_rges.cisplatin, biomarker.FC.fit)

# limit the data set to numerical values: rges, ic50 and biomarkers:
# ic50 values are in -log10 scale
ic50.cisplatin = drug_activity_rges.cisplatin[,9]
IC50.value.cisplatin = 10^-(ic50.cisplatin)
RGES.cisplatin = drug_activity_rges.cisplatin[,2]
rges.ic50.biomarkers <- as.data.frame(cbind(RGES.cisplatin, IC50.value.cisplatin,biomarker.FC.fit))
```

### Correlation between Drug Sensitivity, RGES and Biomarkers

To visualize the correlation pattern between drug sensitivity values, RGES and biomarkers, pairwise scatterplots, as well as a heatmap is produced. 
```{r, echo =FALSE, include= TRUE} 
pairs(rges.ic50.biomarkers, col = "blue", pch = 20, main = "Scatterplots RGES, Drug Sensitivity, Biomarkers")
```


```{r, echo=FALSE, include=TRUE}
cor = cor(rges.ic50.biomarkers)
heatmap(cor, col = cm.colors(256), main = "Heatmap Correlation RGES, Drug Sensitivity, Biomarkers")
```

It can be seen, that there are some biomarkers which show a high correlation with the drug sensitivity values. One aspect, which can result in a problem, is the correlation between the variables. For example FARS2 and CUX1 show a strong correlation between eachother. 
Nevertheless, it will be performed a model with all variables. 

### Computation of the model

As before, to perform a multiple regression model, the data set has to be splitten up into two groups: a training set, which contains 45 random samples (~85% of the whole data set), and a test set out of the other values. 
```{r, echo = FALSE}
# multiple regression model
# create training and test set
train.multiple = sample(1:nrow(rges.ic50.biomarkers), 45)
## 
train.set.multiple = rges.ic50.biomarkers[train.multiple, ]
test.set.multiple = rges.ic50.biomarkers[-train.multiple, ]
```
Afterwards, the multiple regression model can be learned from the test set. All variables are included. 
```{r, echo=FALSE, include=TRUE}
model.multiple = lm(IC50.value.cisplatin ~ ., data = train.set.multiple)
summary(model.multiple)
```
The output of the multiple regression model can be interpreted as follows:
The R² value indicates, that ~11 % of the variability can be explained through the model. Comparing this value to the one of the univariate regression model, the explained variability is improved greatly. 
Nevertheless the F-statistic is next to, so that taking the median as a prediction value is not really worse. 
In addition, the obtained p-values for some variables are quite high. This can be explained by the correlation between some of them. 

```{r, echo=FALSE, include=TRUE}
plot(model.multiple, which = c(1), col="blue", pch = 20, main = "Scatterplot Residuals - Fitted values")
plot(model.multiple, which = c(2), col="blue", pch = 20, main = "QQ plot Residuals")
```

As expected, the residuals are distributed around the red line and therefore do not have non-linear patterns. The QQ plot illustrates, that the residuals are normally distributed.

In order to prove the correlation between residuals and variables, the correlation coefficient is computed.
Correlation coefficient Residuals - Variables (RGES and biomarkers)
```{r, echo=FALSE, include=TRUE}
cor(train.set.multiple[,-2], model.multiple$residuals)
```
As the computation results in a low coefficient, one can exclude a correlation between residuals and x.


### Prediction of data values

At the end the multiple regression model is used to predict the values. The result is shown in a vector.
```{r, echo = FALSE}
predict.multiple = predict(model.multiple, newdata = test.set.multiple)
```

```{r, echo=FALSE, include=TRUE}
plot(test.set.multiple$IC50.value.cisplatin, predict.multiple, xlab = "Real Values", ylab = "Predicted Values", pch=20, col="blue")
abline(0, 1, col = "red")
```

The predicted values look very similar to the real values. Therefore the multiple regression model with RGES and biomarkers enhanced the model as well as the prediction. 


#### Validity of the model

RMSE values for training and test set can be computed.
```{r, echo=FALSE}
n = nrow(train.set.multiple)
rmse.train = sqrt(1/n * sum(model.multiple$residuals^2))
n = nrow(test.set.multiple)
residuals = test.set.multiple$IC50.value.cisplatin - predict.multiple
rmse.test = sqrt(1/n * sum(residuals^2))
```
RMSE training set:
```{r, echo = FALSE, include=TRUE}
rmse.train
```
RMSE test set:
```{r, echo=FALSE, include=TRUE}
rmse.test
```
The RMSE values for training and test set are close to zero. This indicates that the model does fit very well to the real data.
In summary, through an inclusion of further variables, the model could be improved. The explained variablilty, as well as the predicted values were enhanced.

Nevertheless the output showed high p values for some variables, as they correlate to eachother.
For that reason, the correlation between variables and drug sensitivity as well as the correlation between each explanatory variable is observed. Through a new model with only high correlating variables to the drug sensitivty values and low correlationg variables to other explanatory data, the multiple regressioin model should be improved once again.


## 3. Multiple Regression Model Specific
### Variables: 3 biomarkers (GMDS, LRBA, ATXN1)

The correlation heatmap including all variables, as well as the p-values suggest to perform a multiple regression model with three specific biomarkers. GMDS, LRBA and ATXN1 showed a more or less strong correlation to drug sensitivity values. Nevertheless the same training and test set as before is used.

### Computation of the model
```{r, echo = FALSE, include=TRUE}
model.multiple.biomarkers = lm(IC50.value.cisplatin ~ GMDS + LRBA + ATXN1, data = train.set.multiple)
summary(model.multiple.biomarkers)
```
The output illustrates that ~24 % of the variability can be explained by the model. This is more than the double compared to the previous multiple regression model. Also the F-statistic shows a great enhancement and suggests, that the computed model is a better predictor for drug sensitivity values than the mean would be. Nevertheless the p values of LRBA an ATXN1 remained high, indicating a correlation between the variables. 

```{r, echo=FALSE, include=TRUE}
plot(model.multiple.biomarkers, which = c(1), col = "blue", pch = 20, main = "Scatterplot Residuals - Fitted values")
plot(model.multiple.biomarkers, which = c(2), col = "blue", pch = 20, main = "QQ plot Residuals")
```

The residuals do not show non-linear relationships, as well as they are normally distributed.

### Prediction of the data
Now the model can be used to predict the data. 
```{r, echo = FALSE, include=TRUE}
predict.biomarkers = predict(model.multiple.biomarkers, newdata = test.set.multiple)
```
```{r, echo=FALSE, include=TRUE}
plot(test.set.multiple$IC50.value.cisplatin, predict.biomarkers, xlab = "Real Values", ylab = "Predicted Values", pch=20, col="blue")
abline(0, 1, col = "red")
```
As before, the predicted values fit more or less well to the real drug sensitivity values. 

#### Validity of the model
To check the models validity, RMSE values for training and test set can be computed.
```{r, echo=FALSE}
n = nrow(train.set.multiple)
rmse.train = sqrt(1/n * sum(model.multiple.biomarkers$residuals^2))
n = nrow(test.set.multiple)
residuals = test.set.multiple$IC50.value.cisplatin - predict.biomarkers
rmse.test = sqrt(1/n * sum(residuals^2))
```
RMSE training set:
```{r, echo = FALSE, include = TRUE}
rmse.train
```
RMSE test set
```{r, echo = FALSE, include = TRUE}
rmse.test
```
Both RMSE values are close to zero, so that the model fit well to real data. 
All in all the multiple regression model with these 3 specific biomarkers improved the model very much. 

## 4. Multiple Regression Model PCAs
### Variables: PCs

For a further enhancement of the multiple regression model, principle components instead of original variables were used. 
A barplot of the first principle component is illustrated. In addition the correlation between each PCs has to be checked.
```{r, echo=FALSE}
pca = prcomp(rges.ic50.biomarkers[, -2])
```

### Barplot PC1
```{r, echo= FALSE, include=TRUE}
barplot(pca$rotation[, 1], horiz = TRUE, main = "PC1", col = "lightblue",las=1, cex.names = 0.5)
```

It can be seen, that PC 1 corresponds to variation out of every variable except RGES. The highest variation is explained through the biomarkers DPYP, AGAP1 and CUX1.
First, it will be performed a multiple regression model including all PCs.

### Computation of the Model
Finally, the multiple regression model can be computed. 
```{r, echo=FALSE, include=TRUE}
model.pca = lm(IC50.value.cisplatin ~ pca$x)
summary(model.pca)
```

A R² value of ~0.16 is obtained. So through the model less variability is explained than through the model with specific biomarkers. As the F-statistic is next to one, it could not have been proved, that the computed model predicts the drug sensitivity values better than the mean would do. In addition some variables show a high p value. Therefore the correlation between the PCs will have to be checked.

```{r, echo=FALSE, include=TRUE}
plot(model.pca, which = c(1), col = "blue", pch = 20, main = "Scatterplot Residuals - Fitted values")
plot(model.pca, which = c(2), col = "blue", pch = 20, main = "QQ plot Residuals")
```

The two plots suggest, that the residuals are normally distributed, as well as they fit well to the real data.

```{r, echo=FALSE, include=TRUE}
cor.pca = cor(pca$x)
heatmap(cor.pca, col = cm.colors(256), main = "Heatmap Correlation PCs")
```

As the output of the model contained high p values for some variables, the correlation between the PCs was proved. The heatmap illustrates, that there is no correlation between the PCs.

In order to look for the PCs which explain most of the data sets variance, an elbow plot was done.
```{r, echo=FALSE, include=TRUE}
plot(pca, type ="lines", main = "Elbow plot of PCA")
```

PC1 does contain most of the variance and PC2 still a bit more than the following ones. This plot suggests to redo the multiple regression model with these two PCs. 