---
title: "1. Broad Analysis"
date: "5 Juni 2019"
output:
  html_document: default
  pdf_document: default
---
# 1. Broad Analysis

<br/>

<div style="text-align: justify">The goal of the following broad analysis is to gain an overview of the given datasets containing the influence of different drugs on the cellular response. This will be the basis for all next investigations, including the sepcific analysis for cisplatin. </div>



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include= FALSE}
library(viridis)
library(ggplot2)
```

```{r, eval=FALSE}
library(viridis)
library(ggplot2)
```
## 1.1 Table of contents
1. [Cleaning up our data - NAs and scaling](#cleanup)  
2. [Plotting the gene expression unscaled and scaled](#boxplots)  
3. [Computation of the Fold Change - Treated/Untreated](#fc)  
4. [Principal component analysis between treated and untreated data](#pca)  
    4.1 [Colored PCA - drugs](#coldrug)  
    4.2 [Colored PCA - chemo/targeted](#colchemtarg)  
    4.3 [Colored PCA - tyrosine kinase inhibitor](#colTKI)  


```{r, include = FALSE}
treated <- readRDS("C:/Users/johan/Documents/Bioinfo_project/NCI_TPW_gep_treated.rds")
untreated <- readRDS("C:/Users/johan/Documents/Bioinfo_project/NCI_TPW_gep_untreated.rds")
ic50 <- readRDS("C:/Users/johan/Documents/Bioinfo_project/NegLogGI50.rds")
basalexp <- readRDS("C:/Users/johan/Documents/Bioinfo_project/CCLE_basalexpression.rds")
copynumber <- readRDS("C:/Users/johan/Documents/Bioinfo_project/CCLE_copynumber.rds")
mutations <- readRDS("C:/Users/johan/Documents/Bioinfo_project/CCLE_mutations.rds")
cellline <- read.delim("C:/Users/johan/Documents/Bioinfo_project/cellline_annotation.tsv", header = TRUE, sep = "\t")
meta <- read.delim("C:/Users/johan/Documents/Bioinfo_project/NCI_TPW_metadata.tsv", header = TRUE, sep = "\t")
drug <- read.delim("C:/Users/johan/Documents/Bioinfo_project/drug_annotation.tsv", header = TRUE, sep = "\t")
```
  
## 1. Cleaning up our data - NAs and scaling <a name="cleanup"></a> 
<div style="text-align: justify">In order to clean up our data, a loop for checking the amount of NAs in every matrix was created. Rows/Columns containing only NAs were deleted, as they do not contain any information. This only concerned the "mutations" matrix, where two columns were deleted.
Furthermore the data has been scaled for the following investigations.</div>
```{r, include = FALSE}
list.na = list("treated"=treated, "untreated"=untreated, "mutations"=mutations, "basalexp" = basalexp, "cellline"=cellline, "copynumber"=copynumber, "ic50"=ic50, "meta"=meta)
myfunc = function(x){sum(is.na(x))}

i = 0
while(i<9)
{
  p=sapply(list.na[i],myfunc)
  print(p)
  i = i +1
}

mutations.removed = mutations[, -(12:13)]
```

```{r, include = FALSE}
#scale
basal.scaled <- scale(basalexp)
treated.scaled <- scale(treated)
untreated.scaled <- scale(untreated)
```

<br/>
<br/>

## 2. Plotting the gene expression unscaled and scaled <a name="boxplots"></a>

<div style="text-align: justify">In order to get an overview, a boxplot of the treated data was computed and every drug was colored in a different color. There were 15 different batches visible, so another boxplot with the scaled data from treated was computed. The batches dissapeared due to the fact that through scaling, all irregularitys in measuring and experimental conditions were removed.</div>

<br/>
<br/>

```{r, echo=FALSE, fig.width=4.7, fig.height=4, out.extra='style="float:center"'}
drug15 = meta$drug
palette(viridis(15))

par(mar=c(5, 4, 5, 9))
boxplot(treated, medcol="black", border = drug15, col= drug15, 
         xlab="samples", ylab="gene expression",
         main= "Gene expression",
         names= FALSE, xaxt= "n", boxwex=1, boxlty =0)

palette(viridis(15))

par(mar=c(5, 4, 5, 9))
boxplot(treated.scaled, medcol="black", border = drug15, col= drug15, 
         xlab="samples", ylab="gene expression",
         main= "Scaled gene expression",
         names= FALSE, xaxt= "n", boxwex=1, boxlty =0)
```

<br/>

## 3. Computation of the Fold Change - Treated/Untreated <a name="fc"></a>

<div style="text-align: justify">In order to analyze the gene expression change from untreated to treated, log2 fold change values were computed. Because the given data was already log2-transformed, computing the difference between the treated(scaled) and untreated(scaled) data resulted in log2 fold change values. The distribution of the fold change values was checked through a density plot. The values are normally distributed and most values were located near to 0, which implies a similar gene expression before and after treatment. 
Furthermore, it would have also been interesting to explore the density of the fold change values by each cell line and not by all cell lines together.</div>

<br/>
<br/>

```{r}
log2FC.treated.untreated <- treated.scaled - untreated.scaled
```

```{r}
plot(density(log2FC.treated.untreated), main = "Log2 FC Treated/Untreated")
```

<br/>

## 4. Principal component analysis between treated and untreated data <a name="pca"></a>

<div style="text-align: justify">For a dimensionallity reduction, a principal component analysis was performed. Component 4 was chosen as the last significant component, regarding to the elbow plot. </div>

<br/>
<br/>

```{r}
PCA.FC <- prcomp(log2FC.treated.untreated, center=F , scale.=F)
plot(PCA.FC, type ="lines")
```

```{r, echo=FALSE}
Varianz.PCA=PCA.FC$sdev^2
```

<div style="text-align: justify">The PCA was interpreted by plotting the first four components in different plots, and coloring different groups of data.</div>
  
```{r, echo=FALSE, fig.width=4, fig.height=4, out.extra='style="float:center"'}
plot(PCA.FC$rotation[, 1], PCA.FC$rotation[, 2], xlab = "PC1", ylab = "PC2", pch=19, main = "PCA Treated/Untreated")
plot(PCA.FC$rotation[, 3], PCA.FC$rotation[, 4], xlab = "PC3", ylab = "PC4", pch = 19, main = "Treated/Untreated")
```

<br/>

### 4.1 Colored PCA - drugs <a name="coldrug"></a>
<div style="text-align: justify">Firstly, each drug was colored in a different color. PC1 and PC2 don't seem to show any separations, but PC3 and PC4 seem to seperate the diffenrent drugs, especially Vorinostat an Bortezomib.</div>

<br/>

```{r, echo=FALSE}
pca = PCA.FC
meta_neu = meta[1:819,]
meta_neu = as.data.frame(meta_neu)

pca_plot_drugs12 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,1], y = pca$rotation[,2])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$drug))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  #mit BREWER: scale_fill_brewer(palette = "Dark2")
  ggtitle("Principal Component Analysis - color drugs") +
  xlab("Principal Component 1") +
  ylab("Principal Component 2")

pca_plot_drugs34 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,3], y = pca$rotation[,4])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$drug))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  #mit BREWER: scale_fill_brewer(palette = "Dark2")
  ggtitle("Principal Component Analysis - color drugs") +
  xlab("Principal Component 3") +
  ylab("Principal Component 4")
```

```{r, eval=FALSE}
pca_plot_drugs12
pca_plot_drugs34
```

```{r, echo= FALSE, dpi=100, fig.width=4, fig.height=4, out.extra='style="float:center"', fig.align='center'}
pca_plot_drugs12
pca_plot_drugs34
```

<br/>

<div style="text-align: justify">This could be because vorinostat is the only HDAC inhibitor. It is a cytostatic drug used in T-cell lymphomas and therefore it is very specific. Bortezomib is the only proteasome inhibitor and causes the loss of function of the proteasome. This loss of function results in the inhibition of different proteins, which leads to apoptosis and downregulation of the cell cycle. </div>

<br/>

### 4.2 Colored PCA - chemo/targeted <a name="colchemtarg"></a>
<div style="text-align: justify">Secondly, chemotherapeutics and targeted drugs were colored in both plots. This coloring did not result in a completely clear subdivision.</div>

<br/>

```{r, echo=FALSE}
targeted.chemo <- c("targeted", "targeted", "chemo", "chemo", "chemo", "chemo", "chemo", "targeted", "targeted", "chemo", "chemo", "chemo", "chemo", "targeted", "chemo")
drug.added <- cbind(drug, targeted.chemo)
drug.added.ordered <- drug.added[order(drug.added$Drug),]

chem.targ = c(rep(as.numeric(0),819))
meta_neu = cbind(meta_neu, chem.targ)

i=1
j=1

while(j<16)
{while(i<820)
{
  if(isTRUE(meta_neu[i,3]== drug.added.ordered[j,1]))
  {meta_neu[i,7] = as.character(drug.added.ordered[j,9])
  }
  i = i +1
}
  i= 1
  j=j+1}

pca_plot_chemtarg12 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,1], y = pca$rotation[,2])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$chem.targ))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  #mit BREWER: scale_fill_brewer(palette = "Dark2")
  ggtitle("Principal Component Analysis chemo/targeted") +
  xlab("Principal Component 1") +
  ylab("Principal Component 2")

pca_plot_chemtarg34 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,3], y = pca$rotation[,4])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$chem.targ))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  #mit BREWER: scale_fill_brewer(palette = "Dark2")
  ggtitle("Principal Component Analysis chemo/targeted") +
  xlab("Principal Component 3") +
  ylab("Principal Component 4")
```

```{r, eval=FALSE}
pca_plot_chemtarg12
pca_plot_chemtarg34
```

```{r, echo= FALSE, dpi=100, fig.width=4, fig.height=4, out.extra='style="float:center"', fig.align='center'}
pca_plot_chemtarg12
pca_plot_chemtarg34
```

<br/>

### 4.3 Colored PCA - tyrosine kinase inhibitor <a name="colTKI"></a>
<div style="text-align: justify">Lastly, the 4 tyrosine kinase inhibitor (TKI) drugs (dasatinib, sunitinib, lapatinib, sorafenib) were colored. There was no seperation visible in PC1 and PC2. By plotting PC3 and PC4, a batch of only TKI became visible. Although there are also many different drugs located in the same area, the concentration of the TKI may result from the specific and targeted mechanism.</div>

<br/>

```{r, echo=FALSE}
TKI = c(rep(as.numeric(0),819))
meta_neu = cbind(meta_neu, TKI)

i=1
j=1

while(j<16)
{while(i<820)
{
  if(isTRUE(meta_neu[i,3]== drug.added.ordered[j,1])
     & (drug.added.ordered[j,3] == "Tyrosine kinase inhibitor"))
  {meta_neu[i,8] = as.character(drug.added.ordered[j,3])
  }
  i = i +1
}
  i= 1
  j=j+1}

pca_plot_TKI12 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,1], y = pca$rotation[,2])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$TKI))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  ggtitle("Principal Component Analysis - color TKI") +
  xlab("Principal Component 1") +
  ylab("Principal Component 2")

pca_plot_TKI34 <- ggplot(as.data.frame(pca$rotation), aes(x= pca$rotation[,3], y = pca$rotation[,4])) +
  theme_bw(base_size = 7) +
  geom_point(aes(colour = factor(meta_neu$TKI))) +
  scale_colour_viridis(option ="viridis", discrete = TRUE) +
  ggtitle("Principal Component Analysis - color TKI") +
  xlab("Principal Component 3") +
  ylab("Principal Component 4")
```

```{r, eval=FALSE}
pca_plot_TKI12
pca_plot_TKI34
```

```{r, echo= FALSE, dpi=100, fig.width=4, fig.height=4, out.extra='style="float:center"', fig.align='center'}
pca_plot_TKI12
pca_plot_TKI34
```